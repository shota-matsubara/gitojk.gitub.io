import streamlit as st
import pandas as pd
import matplotlib.pyplot as plt
import os
import glob
from pptx import Presentation
from pptx.util import Inches, Pt
from datetime import datetime
import google.generativeai as genai

# --- è¨­å®š ---
st.set_page_config(page_title="CSVåˆ†æã¨PPTè‡ªå‹•ç”Ÿæˆ", layout="wide")
st.title("CSVãƒ‡ãƒ¼ã‚¿åˆ†æ & Geminiç¤ºå”† & PowerPointå‡ºåŠ›")

# --- CSVãƒ•ã‚¡ã‚¤ãƒ«ãƒ•ã‚©ãƒ«ãƒ€ã®æŒ‡å®š ---
CSV_FOLDER = "C:\\Users\\shomatsubara\\Documents\\Python_project\\"  # CSVãƒ•ã‚¡ã‚¤ãƒ«ãŒæ ¼ç´ã•ã‚Œã¦ã„ã‚‹ãƒ•ã‚©ãƒ«ãƒ€

# --- CSVãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã®å–å¾— ---
@st.cache_data
def get_csv_files(folder_path):
    """æŒ‡å®šãƒ•ã‚©ãƒ«ãƒ€å†…ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’å–å¾—"""
    try:
        csv_pattern = os.path.join(folder_path, "*.csv")
        csv_files = glob.glob(csv_pattern)
        # ãƒ•ã‚¡ã‚¤ãƒ«åã®ã¿ã‚’æŠ½å‡ºï¼ˆãƒ‘ã‚¹ãªã—ï¼‰
        csv_filenames = [os.path.basename(file) for file in csv_files]
        return csv_files, csv_filenames
    except Exception as e:
        st.error(f"CSVãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œç´¢ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
        return [], []

# --- ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ ---
st.subheader("â‘  CSVãƒ•ã‚¡ã‚¤ãƒ«ã®é¸æŠ")

csv_full_paths, csv_filenames = get_csv_files(CSV_FOLDER)

if not csv_filenames:
    st.error(f"æŒ‡å®šãƒ•ã‚©ãƒ«ãƒ€ã€Œ{CSV_FOLDER}ã€ã«CSVãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚")
    st.stop()

# ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã§ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ
selected_filename = st.selectbox(
    "åˆ†æã™ã‚‹CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„:",
    csv_filenames,
    index=0
)

# é¸æŠã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ•ãƒ«ãƒ‘ã‚¹ã‚’å–å¾—
selected_file_index = csv_filenames.index(selected_filename)
selected_csv_path = csv_full_paths[selected_file_index]

st.info(f"é¸æŠã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«: {selected_filename}")

# --- Gemini APIã‚­ãƒ¼ã®å–å¾— ---
api_key = os.getenv("GOOGLE_API_KEY")
if not api_key:
    st.error("ç’°å¢ƒå¤‰æ•°  'GOOGLE_API_KEY' ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚PowerShell ã¾ãŸã¯ .env ã§è¨­å®šã—ã¦ãã ã•ã„ã€‚")
    st.stop()

# --- ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ ---
st.subheader("â‘¡ ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã¨ç¢ºèª")

@st.cache_data
def load_csv_data(file_path):
    """CSVãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã€å‰å‡¦ç†ã‚’è¡Œã†"""
    try:
        df = pd.read_csv(file_path, encoding="utf-8")
        df.columns = df.columns.str.strip()
        
        # å¿…è¦ãªåˆ—ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯
        if "timeCd" not in df.columns or "value" not in df.columns:
            return None, "CSVãƒ•ã‚¡ã‚¤ãƒ«ã« 'timeCd' ã¨ 'value' ã®åˆ—ãŒå¿…è¦ã§ã™ã€‚"
        
        # ãƒ‡ãƒ¼ã‚¿ã®å‰å‡¦ç†
        df['timeCd'] = df['timeCd'].astype(str)
        
        # æ—¥ä»˜å¤‰æ›ã®æ”¹å–„ï¼ˆè¤‡æ•°ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«å¯¾å¿œï¼‰
        df['Date'] = None
        
        # ã¾ãš6æ¡ã®å¹´æœˆãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆYYYYMMï¼‰ã‚’è©¦ã™
        mask_6digit = df['timeCd'].str.len() >= 6
        if mask_6digit.any():
            df.loc[mask_6digit, 'Date'] = pd.to_datetime(
                df.loc[mask_6digit, 'timeCd'].str[:6], 
                format='%Y%m', 
                errors='coerce'
            )
        
        # 8æ¡ã®å¹´æœˆæ—¥ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆYYYYMMDDï¼‰ã‚‚è©¦ã™
        mask_8digit = df['timeCd'].str.len() >= 8
        if mask_8digit.any():
            df.loc[mask_8digit & df['Date'].isna(), 'Date'] = pd.to_datetime(
                df.loc[mask_8digit & df['Date'].isna(), 'timeCd'].str[:8], 
                format='%Y%m%d', 
                errors='coerce'
            )
        
        # 4æ¡ã®å¹´ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆYYYYï¼‰ã‚‚è©¦ã™
        mask_4digit = df['timeCd'].str.len() == 4
        if mask_4digit.any():
            df.loc[mask_4digit & df['Date'].isna(), 'Date'] = pd.to_datetime(
                df.loc[mask_4digit & df['Date'].isna(), 'timeCd'] + '01', 
                format='%Y%m', 
                errors='coerce'
            )
        
        # æ—¥ä»˜å¤‰æ›ã«å¤±æ•—ã—ãŸè¡Œã‚’å‰Šé™¤
        initial_count = len(df)
        df = df.dropna(subset=['Date'])
        df = df.rename(columns={'value': 'Value'})
        
        # æ•°å€¤ãƒ‡ãƒ¼ã‚¿ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        df['Value'] = pd.to_numeric(df['Value'], errors='coerce')
        df = df.dropna(subset=['Value'])
        
        final_count = len(df)
        
        if final_count == 0:
            return None, "æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚æ—¥ä»˜å½¢å¼ã¾ãŸã¯æ•°å€¤å½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
        
        # ãƒ‡ãƒ¼ã‚¿ãŒå¤§å¹…ã«æ¸›å°‘ã—ãŸå ´åˆã®è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        if final_count < initial_count * 0.5:
            warning_msg = f"æ³¨æ„: ãƒ‡ãƒ¼ã‚¿ã®{initial_count - final_count}è¡ŒãŒç„¡åŠ¹ãªå½¢å¼ã®ãŸã‚é™¤å¤–ã•ã‚Œã¾ã—ãŸã€‚"
            return df, warning_msg
        
        return df, None
    except Exception as e:
        return None, f"CSV èª­ã¿è¾¼ã¿å¤±æ•—: {e}"

# ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Ÿè¡Œ
df, error_message = load_csv_data(selected_csv_path)

if error_message:
    if "æ³¨æ„:" in error_message:
        st.warning(error_message)
    else:
        st.error(error_message)
        st.stop()

# ãƒ‡ãƒ¼ã‚¿ã®åŸºæœ¬ãƒã‚§ãƒƒã‚¯
if df is None or len(df) == 0:
    st.error("æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚")
    st.stop()

# ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
st.write(f"**ãƒ‡ãƒ¼ã‚¿ä»¶æ•°:** {len(df)}è¡Œ")

# æ—¥ä»˜ç¯„å›²ã®å®‰å…¨ãªè¡¨ç¤º
if not df['Date'].isna().all():
    date_min = df['Date'].min()
    date_max = df['Date'].max()
    if pd.notna(date_min) and pd.notna(date_max):
        st.write(f"**æœŸé–“:** {date_min.strftime('%Yå¹´%mæœˆ')} ï½ {date_max.strftime('%Yå¹´%mæœˆ')}")
    else:
        st.write("**æœŸé–“:** æ—¥ä»˜æƒ…å ±ãŒä¸å®Œå…¨ã§ã™")
else:
    st.write("**æœŸé–“:** æ—¥ä»˜æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ")

st.dataframe(df.head(10))

# --- ã‚°ãƒ©ãƒ•æç”» ---
st.subheader("â‘¢ çµŒæ¸ˆãƒˆãƒ¬ãƒ³ãƒ‰ã®å¯è¦–åŒ–")

# ã‚°ãƒ©ãƒ•æç”»
fig, ax = plt.subplots(figsize=(12, 6))
graph_title = f"{selected_filename.replace('.csv', '')} - Economic Trend Analysis"
ax.plot(df['Date'], df['Value'], marker='o', linewidth=2, markersize=4)
ax.set_title(graph_title, fontsize=16, pad=20)
ax.set_xlabel("Date", fontsize=12)
ax.set_ylabel("Value", fontsize=12)
ax.grid(True, alpha=0.3)
plt.xticks(rotation=45)
plt.tight_layout()

st.pyplot(fig)

# ãƒ‡ãƒ¼ã‚¿çµ±è¨ˆæƒ…å ±ã®è¡¨ç¤º
col1, col2, col3, col4 = st.columns(4)
with col1:
    st.metric("æœ€å¤§å€¤", f"{df['Value'].max():.2f}")
with col2:
    st.metric("æœ€å°å€¤", f"{df['Value'].min():.2f}")
with col3:
    st.metric("å¹³å‡å€¤", f"{df['Value'].mean():.2f}")
with col4:
    if df['Value'].std() is not None:
        st.metric("æ¨™æº–åå·®", f"{df['Value'].std():.2f}")
    else:
        st.metric("æ¨™æº–åå·®", "N/A")

# --- Gemini API ã«ã‚ˆã‚‹ç¤ºå”†ã®ç”Ÿæˆ ---
st.subheader("â‘£ Gemini ã«ã‚ˆã‚‹ç¤ºå”†ã®ç”Ÿæˆ")

# Geminiè¨­å®š
genai.configure(api_key=api_key)
model = genai.GenerativeModel("gemini-2.5-flash-preview-04-17")

# ãƒ‡ãƒ¼ã‚¿æº–å‚™ï¼ˆæœ€æ–°100è¡Œã‚’ä½¿ç”¨ï¼‰
csv_data_for_prompt = (
    df.sort_values("Date")[["Date", "Value"]]
    .tail(100)
    .to_string(index=False)
)

# ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä½œæˆ
date_min = df['Date'].min()
date_max = df['Date'].max()
date_range_text = ""
if pd.notna(date_min) and pd.notna(date_max):
    date_range_text = f"- æœŸé–“: {date_min.strftime('%Yå¹´%mæœˆ')} ï½ {date_max.strftime('%Yå¹´%mæœˆ')}\n"
else:
    date_range_text = "- æœŸé–“: æ—¥ä»˜æƒ…å ±ãŒä¸å®Œå…¨\n"

prompt = (
    f"ãƒ•ã‚¡ã‚¤ãƒ«å: {selected_filename}\n"
    f"ã‚°ãƒ©ãƒ•ã‚¿ã‚¤ãƒˆãƒ«: {graph_title}\n\n"
    "ä»¥ä¸‹ã¯æ™‚ç³»åˆ—ã®çµŒæ¸ˆãƒ‡ãƒ¼ã‚¿ã§ã™ã€‚\n"
    "ã“ã®ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ã¦ã€\n"
    "1. æ³¨ç›®ã™ã¹ãå‚¾å‘ã¨ç†ç”±ã‚’\n"
    "ã‚’50æ–‡å­—ä»¥å†…ã§ç«¯çš„ã«è¿°ã¹ã¦ãã ã•ã„ã€‚ãã®éš›ã€æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ãƒˆã¯è¡¨ç¤ºä¸è¦ã§ã™ã€‚\n\n"
    f"ãƒ‡ãƒ¼ã‚¿çµ±è¨ˆ:\n"
    f"{date_range_text}"
    f"- æœ€å¤§å€¤: {df['Value'].max():.2f}\n"
    f"- æœ€å°å€¤: {df['Value'].min():.2f}\n"
    f"- å¹³å‡å€¤: {df['Value'].mean():.2f}\n\n"
    "ã€ãƒˆãƒ¬ãƒ³ãƒ‰ãƒ‡ãƒ¼ã‚¿ï¼ˆDate, Valueï¼‰ã€‘:\n"
    f"{csv_data_for_prompt}"
)

# ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¿ã‚¤ãƒˆãƒ«ç”Ÿæˆç”¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
title_prompt = (
    f"ãƒ•ã‚¡ã‚¤ãƒ«å: {selected_filename}\n"
    f"ã‚°ãƒ©ãƒ•ã‚¿ã‚¤ãƒˆãƒ«: {graph_title}\n\n"
    "ä»¥ä¸‹ã¯æ™‚ç³»åˆ—ã®çµŒæ¸ˆãƒ‡ãƒ¼ã‚¿ã§ã™ã€‚\n"
    "ã“ã®ãƒ‡ãƒ¼ã‚¿ã®åˆ†æçµæœã‚’è¡¨ç¾ã™ã‚‹ã€\n"
    "15æ–‡å­—ç¨‹åº¦ã®ç°¡æ½”ãªã‚¿ã‚¤ãƒˆãƒ«ã‚’1ã¤ã ã‘ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚\n"
    "ã‚¿ã‚¤ãƒˆãƒ«ã®ã¿ã‚’å›ç­”ã—ã€èª¬æ˜æ–‡ã¯ä¸è¦ã§ã™ã€‚\n\n"
    "ã€ãƒˆãƒ¬ãƒ³ãƒ‰ãƒ‡ãƒ¼ã‚¿ï¼ˆDate, Valueï¼‰ã€‘:\n"
    f"{csv_data_for_prompt}"
)

# --- Geminiå®Ÿè¡Œãƒœã‚¿ãƒ³ ---
if st.button("ğŸ¤– Geminiã§ç¤ºå”†ã‚’ç”Ÿæˆ", type="primary"):
    with st.spinner("GeminiãŒåˆ†æä¸­..."):
        try:
            # ç¤ºå”†ã¨ã‚¿ã‚¤ãƒˆãƒ«ã‚’åŒæ™‚ã«ç”Ÿæˆ
            response = model.generate_content(prompt)
            insight = response.text.strip()
            
            title_response = model.generate_content(title_prompt)
            slide_title = title_response.text.strip()
            
            # çµæœè¡¨ç¤º
            st.success("âœ… Geminiã‹ã‚‰ã®ç¤ºå”†:")
            st.markdown(f"**{insight}**")
            st.success("âœ… ç”Ÿæˆã•ã‚ŒãŸã‚¿ã‚¤ãƒˆãƒ«:")
            st.markdown(f"**{slide_title}**")

            # --- PowerPoint ä½œæˆ ---
            st.subheader("â‘¤ PowerPoint å‡ºåŠ›")
            
            with st.spinner("PowerPointã‚’ç”Ÿæˆä¸­..."):
                prs = Presentation()

                # ã‚¿ã‚¤ãƒˆãƒ«ã‚¹ãƒ©ã‚¤ãƒ‰ï¼ˆ1æšç›®ï¼‰
                slide = prs.slides.add_slide(prs.slide_layouts[0])
                slide.shapes.title.text = "çµŒæ¸ˆãƒ‡ãƒ¼ã‚¿åˆ†æãƒ¬ãƒãƒ¼ãƒˆ"
                slide.placeholders[1].text = f"åˆ†æå¯¾è±¡: {selected_filename}\nGeminiã«ã‚ˆã‚‹ç¤ºå”†ã‚’å«ã‚€"

                # çµ±åˆã‚¹ãƒ©ã‚¤ãƒ‰ï¼ˆ2æšç›®ï¼šã‚¿ã‚¤ãƒˆãƒ« + ç¤ºå”† + ã‚°ãƒ©ãƒ•ã‚’1æšã«ç¸¦é…ç½®ï¼‰
                slide = prs.slides.add_slide(prs.slide_layouts[6])  # ç©ºç™½ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
                
                # ä¸Šéƒ¨ã«Geminiç”Ÿæˆã‚¿ã‚¤ãƒˆãƒ«ã‚’é…ç½®
                title_textbox = slide.shapes.add_textbox(Inches(0.5), Inches(0.2), Inches(9), Inches(0.8))
                title_text_frame = title_textbox.text_frame
                title_text_frame.clear()
                
                title_para = title_text_frame.add_paragraph()
                title_para.text = slide_title
                title_para.font.size = Pt(24)
                title_para.font.bold = True
                
                # ã‚¿ã‚¤ãƒˆãƒ«ä¸‹ã«ãƒªãƒ¼ãƒ‰æ–‡ã¨ã—ã¦ç¤ºå”†ã‚’é…ç½®
                textbox = slide.shapes.add_textbox(Inches(0.5), Inches(1.2), Inches(9), Inches(1.5))
                text_frame = textbox.text_frame
                text_frame.clear()
                
                # ãƒªãƒ¼ãƒ‰æ–‡ã¨ã—ã¦ç¤ºå”†å†…å®¹ã‚’é…ç½®
                lead_para = text_frame.add_paragraph()
                lead_para.text = insight
                lead_para.font.size = Pt(16)
                
                # ä¸‹éƒ¨ä¸­å¤®ã«ã‚°ãƒ©ãƒ•ã‚’é…ç½®
                graph_path = f"trend_plot_{selected_filename.replace('.csv', '')}.png"
                fig.savefig(graph_path, dpi=150, bbox_inches='tight')
                slide.shapes.add_picture(graph_path, Inches(1.5), Inches(3), width=Inches(7), height=Inches(4))

                # ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³
                pptx_filename = f"economic_insight_report_{selected_filename.replace('.csv', '')}.pptx"
                prs.save(pptx_filename)
                
                with open(pptx_filename, "rb") as f:
                    st.download_button(
                        "ğŸ“¥ PowerPointã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰",
                        data=f,
                        file_name=pptx_filename,
                        mime="application/vnd.openxmlformats-officedocument.presentationml.presentation",
                        type="primary"
                    )
                
                st.success(f"âœ… PowerPointãƒ•ã‚¡ã‚¤ãƒ«ã€Œ{pptx_filename}ã€ãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸï¼")

        except Exception as e:
            st.error(f"âŒ Gemini APIã‚¨ãƒ©ãƒ¼: {e}")

# --- ã‚µã‚¤ãƒ‰ãƒãƒ¼ã«è¿½åŠ æƒ…å ± ---
with st.sidebar:
    st.header("ğŸ“Š ã‚¢ãƒ—ãƒªæƒ…å ±")
    st.info(f"**æ¤œç´¢ãƒ•ã‚©ãƒ«ãƒ€:** {CSV_FOLDER}")
    st.info(f"**åˆ©ç”¨å¯èƒ½ãƒ•ã‚¡ã‚¤ãƒ«æ•°:** {len(csv_filenames)}å€‹")
    
    if csv_filenames:
        st.write("**åˆ©ç”¨å¯èƒ½ãªCSVãƒ•ã‚¡ã‚¤ãƒ«:**")
        for i, filename in enumerate(csv_filenames, 1):
            if filename == selected_filename:
                st.write(f"âœ… {i}. **{filename}** (é¸æŠä¸­)")
            else:
                st.write(f"   {i}. {filename}")

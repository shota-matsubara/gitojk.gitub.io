import streamlit as st
import pandas as pd
import matplotlib.pyplot as plt
import matplotlib.font_manager as fm
import os
import glob
from pptx import Presentation
from pptx.util import Inches, Pt
from datetime import datetime
import google.generativeai as genai

# --- æ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆè¨­å®š ---
def setup_japanese_font():
    """æ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆã‚’è¨­å®š"""
    # Windowsã®å ´åˆã®ãƒ•ã‚©ãƒ³ãƒˆå€™è£œ
    font_candidates = [
        'Yu Gothic',           # Windows 10/11æ¨™æº–
        'Meiryo',             # Windowsæ¨™æº–
        'MS Gothic',          # Windowsæ¨™æº–
        'Hiragino Sans',      # macOS
        'DejaVu Sans'         # Linuxï¼ˆæ—¥æœ¬èªã¯è¡¨ç¤ºã•ã‚Œãªã„ãŒã€ã‚¨ãƒ©ãƒ¼ã‚’é˜²ãï¼‰
    ]
    
    available_fonts = [f.name for f in fm.fontManager.ttflist]
    
    for font_name in font_candidates:
        if font_name in available_fonts:
            plt.rcParams['font.family'] = font_name
            st.info(f"æ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆè¨­å®š: {font_name}")
            return font_name
    
    # ãƒ•ã‚©ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã®è­¦å‘Š
    st.warning("æ—¥æœ¬èªå¯¾å¿œãƒ•ã‚©ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚°ãƒ©ãƒ•ã®æ—¥æœ¬èªãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚")
    return None

# --- è¨­å®š ---
st.set_page_config(page_title="CSVåˆ†æã¨PPTè‡ªå‹•ç”Ÿæˆ", layout="wide")
st.title("CSVãƒ‡ãƒ¼ã‚¿åˆ†æ & Geminiç¤ºå”† & PowerPointå‡ºåŠ›")

# æ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆè¨­å®šã‚’å®Ÿè¡Œ
setup_japanese_font()

# --- ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã®å®šç¾© ---
# CSVãƒ•ã‚¡ã‚¤ãƒ«ãŒæ ¼ç´ã•ã‚Œã¦ã„ã‚‹ãƒ•ã‚©ãƒ«ãƒ€
CSV_FOLDER = "C:\\Users\\shomatsubara\\Documents\\Python_project\\"

# â˜…â˜…â˜… ä½¿ç”¨ã™ã‚‹PowerPointãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ãƒ•ãƒ«ãƒ‘ã‚¹ã‚’æŒ‡å®š â˜…â˜…â˜…
# â€» .ppt ã§ã¯ãªãã€.pptx å½¢å¼ã§ä¿å­˜ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ã‚’æŒ‡å®šã—ã¦ãã ã•ã„
PPTX_TEMPLATE_PATH = "C:\\Users\\shomatsubara\\OneDrive - ABeam Consulting Ltd\\ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ\\æ–°äººç ”ä¿®\\"

# --- CSVãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚«ãƒ†ã‚´ãƒªå®šç¾© ---
CSV_CATEGORIES = {
    "é‡‘è": [
        "ã‚³ãƒ¼ãƒ«å¸‚å ´çµ±è¨ˆï¼œæ—¥æœ¬éŠ€è¡Œï¼.csv",
        "ãƒãƒã‚¿ãƒªãƒ¼ãƒ™ãƒ¼ã‚¹å¹³å‡æ®‹é«˜.csv",
        "ãƒãƒãƒ¼ã‚¹ãƒˆãƒƒã‚¯çµ±è¨ˆï¼œæ—¥æœ¬éŠ€è¡Œï¼.csv",
        "å›½å†…ä¼æ¥­ç‰©ä¾¡æŒ‡æ•°ï¼ˆç·å¹³å‡ï¼‰2020å¹´åŸºæº–.csv",
        "è²¸å‡ºãƒ»é é‡‘å‹•å‘ï¼œæ—¥æœ¬éŠ€è¡Œï¼.csv",
        "çŸ­è¦³_boj.csv",
        "æ±è¨¼æ ªä¾¡æŒ‡æ•°ï¼ˆTOPIXï¼‰.csv",
        "è¼¸å…¥ç‰©ä¾¡æŒ‡æ•°ï¼ˆç·å¹³å‡ï¼‰ï¼ˆå††ãƒ™ãƒ¼ã‚¹ï¼‰2020å¹´åŸºæº–.csv",
        "è¼¸å‡ºç‰©ä¾¡æŒ‡æ•°ï¼ˆç·å¹³å‡ï¼‰ï¼ˆå††ãƒ™ãƒ¼ã‚¹ï¼‰2020å¹´åŸºæº–.csv"
    ],
    "ä¼æ¥­ãƒ»å®¶è¨ˆãƒ»çµŒæ¸ˆ": [
        "ä¼æ¥­ç­‰æ•°.csv",
        "æ™¯æ°—å‹•å‘æŒ‡æ•°ï¼ˆä¸€è‡´ï¼‰2015å¹´åŸºæº–.csv",
        "æ™¯æ°—å‹•å‘æŒ‡æ•°ï¼ˆä¸€è‡´ï¼‰2020å¹´åŸºæº–.csv",
        "æ¶ˆè²»è€…ç‰©ä¾¡æŒ‡æ•°ï¼ˆç·åˆï¼‰2015å¹´åŸºæº–.csv",
        "æ¶ˆè²»è€…ç‰©ä¾¡æŒ‡æ•°ï¼ˆç·åˆï¼‰2020å¹´åŸºæº–.csv",
        "å›½å†…ç·ç”Ÿç”£ï¼ˆæ”¯å‡ºå´ï¼‰ï¼ˆåç›®ï¼‰ï¼ˆç±³ãƒ‰ãƒ«è¡¨ç¤ºï¼‰.csv"
    ],
    "é‰±æ¥­": [
        "é‰±å·¥æ¥­ç”Ÿç”£æŒ‡æ•°ã€€2015å¹´åŸºæº–.csv",
        "é‰±å·¥æ¥­ç”Ÿç”£æŒ‡æ•°ã€€2020å¹´åŸºæº–.csv",
        "è£½é€ å·¥æ¥­ç”Ÿç”£èƒ½åŠ›æŒ‡æ•°ã€€2015å¹´åŸºæº–.csv",
        "è£½é€ å·¥æ¥­ç”Ÿç”£èƒ½åŠ›æŒ‡æ•°ã€€2020å¹´åŸºæº–.csv",
        "è£½é€ å·¥æ¥­ç¨¼åƒç‡æŒ‡æ•°ã€€2015å¹´åŸºæº–.csv",
        "è£½é€ å·¥æ¥­ç¨¼åƒç‡æŒ‡æ•°ã€€2020å¹´åŸºæº–.csv"
    ],
    "ä½å®…ãƒ»åœŸåœ°ãƒ»å»ºç‰©": [
        "ä½å®…æ•°.csv"
    ],
    "äººå£ãƒ»ä¸–å¸¯": [
        "ä¸–å¸¯æ•°ï¼ˆç·æ•°ï¼‰.csv",
        "å‡ºç”Ÿæ•°ï¼ˆå¤–å›½äººã‚’å«ã‚€ï¼‰.csv",
        "å‡ºç”Ÿç‡ï¼ˆäººå£åƒå¯¾ï¼‰.csv",
        "æ­»äº¡æ•°ï¼ˆå¤–å›½äººã‚’å«ã‚€ï¼‰.csv",
        "æ­»äº¡ç‡ï¼ˆäººå£åƒå¯¾ï¼‰.csv",
        "ç·äººå£ï¼ˆç·æ•°ï¼‰.csv"
    ],
    "åŠ´åƒãƒ»è³ƒé‡‘": [
        "å®Œå…¨å¤±æ¥­ç‡ï¼ˆç”·å¥³è¨ˆï¼‰.csv",
        "å®Ÿè³ªè³ƒé‡‘æŒ‡æ•°ï¼ˆç¾é‡‘çµ¦ä¸ç·é¡ï¼‰.csv",
        "å°±æ¥­ç‡ï¼ˆç·æ•°ï¼‰.csv",
        "å½¹å“¡ã‚’é™¤ãé›‡ç”¨è€…ã«å ã‚ã‚‹éæ­£è¦ã®è·å“¡ãƒ»å¾“æ¥­å“¡ã®å‰²åˆï¼ˆç”·å¥³è¨ˆï¼‰.csv",
        "æ­£è¦ã®è·å“¡ãƒ»å¾“æ¥­å“¡ï¼ˆç”·å¥³è¨ˆï¼‰.csv",
        "éæ­£è¦ã®è·å“¡ãƒ»å¾“æ¥­å“¡ï¼ˆç”·å¥³è¨ˆï¼‰.csv"
    ]
}

@st.cache_data
def get_categorized_csv_files(folder_path, categories):
    """ã‚«ãƒ†ã‚´ãƒªåˆ¥ã«CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ•´ç†"""
    try:
        csv_pattern = os.path.join(folder_path, "*.csv")
        all_csv_files = glob.glob(csv_pattern)
        all_csv_filenames = [os.path.basename(file) for file in all_csv_files]
        
        # ã‚«ãƒ†ã‚´ãƒªåˆ¥ã«æ•´ç†
        categorized_files = {}
        categorized_paths = {}
        
        for category, filenames in categories.items():
            category_files = []
            category_paths = []
            
            for filename in filenames:
                if filename in all_csv_filenames:
                    category_files.append(filename)
                    # ãƒ•ãƒ«ãƒ‘ã‚¹ã‚’å–å¾—
                    file_index = all_csv_filenames.index(filename)
                    category_paths.append(all_csv_files[file_index])
            
            if category_files:  # ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿è¿½åŠ 
                categorized_files[category] = category_files
                categorized_paths[category] = category_paths
        
        return categorized_files, categorized_paths, all_csv_filenames
    except Exception as e:
        st.error(f"CSVãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œç´¢ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
        return {}, {}, []

# --- ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ ---
st.subheader("â‘  CSVãƒ•ã‚¡ã‚¤ãƒ«ã®é¸æŠ")

categorized_files, categorized_paths, all_filenames = get_categorized_csv_files(CSV_FOLDER, CSV_CATEGORIES)

if not categorized_files:
    st.error(f"æŒ‡å®šãƒ•ã‚©ãƒ«ãƒ€ã€Œ{CSV_FOLDER}ã€ã«å¯¾è±¡ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚")
    st.stop()

# ã‚«ãƒ†ã‚´ãƒªé¸æŠ
col1, col2 = st.columns([1, 2])

with col1:
    selected_category = st.selectbox(
        "ãƒ‡ãƒ¼ã‚¿ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠ:",
        list(categorized_files.keys()),
        index=0
    )

with col2:
    # é¸æŠã•ã‚ŒãŸã‚«ãƒ†ã‚´ãƒªã®ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§
    if selected_category in categorized_files:
        selected_filename = st.selectbox(
            "åˆ†æã™ã‚‹CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ:",
            categorized_files[selected_category],
            index=0
        )
    else:
        st.error("é¸æŠã•ã‚ŒãŸã‚«ãƒ†ã‚´ãƒªã«ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“ã€‚")
        st.stop()

# é¸æŠã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ•ãƒ«ãƒ‘ã‚¹ã‚’å–å¾—
if selected_category in categorized_paths:
    file_index = categorized_files[selected_category].index(selected_filename)
    selected_csv_path = categorized_paths[selected_category][file_index]
else:
    st.error("ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚")
    st.stop()

st.info(f"é¸æŠã•ã‚ŒãŸã‚«ãƒ†ã‚´ãƒª: **{selected_category}**")
st.info(f"é¸æŠã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«: **{selected_filename}**")

# --- Gemini APIã‚­ãƒ¼ã®å–å¾— ---
api_key = os.getenv("GOOGLE_API_KEY")
if not api_key:
    st.error("ç’°å¢ƒå¤‰æ•° 'GOOGLE_API_KEY' ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚PowerShell ã¾ãŸã¯ .env ã§è¨­å®šã—ã¦ãã ã•ã„ã€‚")
    st.stop()

# --- ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ ---
st.subheader("â‘¡ ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã¨ç¢ºèª")

@st.cache_data
def load_csv_data(file_path):
    """CSVãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã€å‰å‡¦ç†ã‚’è¡Œã†"""
    try:
        df = pd.read_csv(file_path, encoding="utf-8")
        df.columns = df.columns.str.strip()
        
        # å¿…è¦ãªåˆ—ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯
        if "timeCd" not in df.columns or "value" not in df.columns:
            return None, "CSVãƒ•ã‚¡ã‚¤ãƒ«ã« 'timeCd' ã¨ 'value' ã®åˆ—ãŒå¿…è¦ã§ã™ã€‚"
        
        # ãƒ‡ãƒ¼ã‚¿ã®å‰å‡¦ç†
        df['timeCd'] = df['timeCd'].astype(str)
        
        # æ—¥ä»˜å¤‰æ›ã®æ”¹å–„ï¼ˆè¤‡æ•°ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«å¯¾å¿œï¼‰
        df['Date'] = None
        
        # ã¾ãš6æ¡ã®å¹´æœˆãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆYYYYMMï¼‰ã‚’è©¦ã™
        mask_6digit = df['timeCd'].str.len() >= 6
        if mask_6digit.any():
            df.loc[mask_6digit, 'Date'] = pd.to_datetime(
                df.loc[mask_6digit, 'timeCd'].str[:6], 
                format='%Y%m', 
                errors='coerce'
            )
        
        # 8æ¡ã®å¹´æœˆæ—¥ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆYYYYMMDDï¼‰ã‚‚è©¦ã™
        mask_8digit = df['timeCd'].str.len() >= 8
        if mask_8digit.any():
            df.loc[mask_8digit & df['Date'].isna(), 'Date'] = pd.to_datetime(
                df.loc[mask_8digit & df['Date'].isna(), 'timeCd'].str[:8], 
                format='%Y%m%d', 
                errors='coerce'
            )
        
        # 4æ¡ã®å¹´ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆYYYYï¼‰ã‚‚è©¦ã™
        mask_4digit = df['timeCd'].str.len() == 4
        if mask_4digit.any():
            df.loc[mask_4digit & df['Date'].isna(), 'Date'] = pd.to_datetime(
                df.loc[mask_4digit & df['Date'].isna(), 'timeCd'] + '01', 
                format='%Y%m', 
                errors='coerce'
            )
        
        # æ—¥ä»˜å¤‰æ›ã«å¤±æ•—ã—ãŸè¡Œã‚’å‰Šé™¤
        initial_count = len(df)
        df = df.dropna(subset=['Date'])
        df = df.rename(columns={'value': 'Value'})
        
        # æ•°å€¤ãƒ‡ãƒ¼ã‚¿ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        df['Value'] = pd.to_numeric(df['Value'], errors='coerce')
        df = df.dropna(subset=['Value'])
        
        final_count = len(df)
        
        if final_count == 0:
            return None, "æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚æ—¥ä»˜å½¢å¼ã¾ãŸã¯æ•°å€¤å½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
        
        # ãƒ‡ãƒ¼ã‚¿ãŒå¤§å¹…ã«æ¸›å°‘ã—ãŸå ´åˆã®è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
        if final_count < initial_count * 0.5:
            warning_msg = f"æ³¨æ„: ãƒ‡ãƒ¼ã‚¿ã®{initial_count - final_count}è¡ŒãŒç„¡åŠ¹ãªå½¢å¼ã®ãŸã‚é™¤å¤–ã•ã‚Œã¾ã—ãŸã€‚"
            return df, warning_msg
        
        return df, None
    except Exception as e:
        return None, f"CSV èª­ã¿è¾¼ã¿å¤±æ•—: {e}"

# ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Ÿè¡Œ
df, error_message = load_csv_data(selected_csv_path)

if error_message:
    if "æ³¨æ„:" in error_message:
        st.warning(error_message)
    else:
        st.error(error_message)
        st.stop()

# ãƒ‡ãƒ¼ã‚¿ã®åŸºæœ¬ãƒã‚§ãƒƒã‚¯
if df is None or len(df) == 0:
    st.error("æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚")
    st.stop()

# ãƒ‡ãƒ¼ã‚¿ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
st.write(f"**ãƒ‡ãƒ¼ã‚¿ä»¶æ•°:** {len(df)}è¡Œ")

# æ—¥ä»˜ç¯„å›²ã®å®‰å…¨ãªè¡¨ç¤º
if not df['Date'].isna().all():
    date_min = df['Date'].min()
    date_max = df['Date'].max()
    if pd.notna(date_min) and pd.notna(date_max):
        st.write(f"**æœŸé–“:** {date_min.strftime('%Yå¹´%mæœˆ')} ï½ {date_max.strftime('%Yå¹´%mæœˆ')}")
    else:
        st.write("**æœŸé–“:** æ—¥ä»˜æƒ…å ±ãŒä¸å®Œå…¨ã§ã™")
else:
    st.write("**æœŸé–“:** æ—¥ä»˜æƒ…å ±ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ")

st.dataframe(df.head(10))

# --- ã‚°ãƒ©ãƒ•æç”» ---
st.subheader("â‘¢ çµŒæ¸ˆãƒˆãƒ¬ãƒ³ãƒ‰ã®å¯è¦–åŒ–")

# ã‚°ãƒ©ãƒ•ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ—¥æœ¬èªå¯¾å¿œã«ä¿®æ­£
graph_title = f"{selected_filename.replace('.csv', '')} - çµŒæ¸ˆå‹•å‘åˆ†æ"

# ã‚°ãƒ©ãƒ•æç”»
fig, ax = plt.subplots(figsize=(12, 6))
ax.plot(df['Date'], df['Value'], marker='o', linewidth=2, markersize=4)
ax.set_title(graph_title, fontsize=16, pad=20)
ax.set_xlabel("å¹´æœˆ", fontsize=12)
ax.set_ylabel("æ•°å€¤", fontsize=12)
ax.grid(True, alpha=0.3)
plt.xticks(rotation=45)
plt.tight_layout()

st.pyplot(fig)

# ãƒ‡ãƒ¼ã‚¿çµ±è¨ˆæƒ…å ±ã®è¡¨ç¤º
col1, col2, col3, col4 = st.columns(4)
with col1:
    st.metric("æœ€å¤§å€¤", f"{df['Value'].max():.2f}")
with col2:
    st.metric("æœ€å°å€¤", f"{df['Value'].min():.2f}")
with col3:
    st.metric("å¹³å‡å€¤", f"{df['Value'].mean():.2f}")
with col4:
    if df['Value'].std() is not None:
        st.metric("æ¨™æº–åå·®", f"{df['Value'].std():.2f}")
    else:
        st.metric("æ¨™æº–åå·®", "N/A")

# --- Gemini API ã«ã‚ˆã‚‹ç¤ºå”†ã®ç”Ÿæˆ ---
st.subheader("â‘£ Gemini ã«ã‚ˆã‚‹ç¤ºå”†ã®ç”Ÿæˆ")

# Geminiè¨­å®š
genai.configure(api_key=api_key)
model = genai.GenerativeModel("gemini-2.5-flash-preview-04-17")

# ãƒ‡ãƒ¼ã‚¿æº–å‚™ï¼ˆæœ€æ–°100è¡Œã‚’ä½¿ç”¨ï¼‰
csv_data_for_prompt = (
    df.sort_values("Date")[["Date", "Value"]]
    .tail(100)
    .to_string(index=False)
)

# ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä½œæˆ
date_min = df['Date'].min()
date_max = df['Date'].max()
date_range_text = ""
if pd.notna(date_min) and pd.notna(date_max):
    date_range_text = f"- æœŸé–“: {date_min.strftime('%Yå¹´%mæœˆ')} ï½ {date_max.strftime('%Yå¹´%mæœˆ')}\n"
else:
    date_range_text = "- æœŸé–“: æ—¥ä»˜æƒ…å ±ãŒä¸å®Œå…¨\n"

prompt = (
    f"ãƒ•ã‚¡ã‚¤ãƒ«å: {selected_filename}\n"
    f"ã‚°ãƒ©ãƒ•ã‚¿ã‚¤ãƒˆãƒ«: {graph_title}\n\n"
    "ä»¥ä¸‹ã¯æ™‚ç³»åˆ—ã®çµŒæ¸ˆãƒ‡ãƒ¼ã‚¿ã§ã™ã€‚\n"
    "ã“ã®ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ã¦ã€\n"
    "1. æ³¨ç›®ã™ã¹ãå‚¾å‘ã¨ç†ç”±ã‚’\n"
    "ã‚’50æ–‡å­—ä»¥å†…ã§ç«¯çš„ã«è¿°ã¹ã¦ãã ã•ã„ã€‚ãã®éš›ã€æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ãƒˆã¯è¡¨ç¤ºä¸è¦ã§ã™ã€‚\n\n"
    f"ãƒ‡ãƒ¼ã‚¿çµ±è¨ˆ:\n"
    f"{date_range_text}"
    f"- æœ€å¤§å€¤: {df['Value'].max():.2f}\n"
    f"- æœ€å°å€¤: {df['Value'].min():.2f}\n"
    f"- å¹³å‡å€¤: {df['Value'].mean():.2f}\n\n"
    "ã€ãƒˆãƒ¬ãƒ³ãƒ‰ãƒ‡ãƒ¼ã‚¿ï¼ˆDate, Valueï¼‰ã€‘:\n"
    f"{csv_data_for_prompt}"
)

# ã‚¹ãƒ©ã‚¤ãƒ‰ã‚¿ã‚¤ãƒˆãƒ«ç”Ÿæˆç”¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
title_prompt = (
    f"ãƒ•ã‚¡ã‚¤ãƒ«å: {selected_filename}\n"
    f"ã‚°ãƒ©ãƒ•ã‚¿ã‚¤ãƒˆãƒ«: {graph_title}\n\n"
    "ä»¥ä¸‹ã¯æ™‚ç³»åˆ—ã®çµŒæ¸ˆãƒ‡ãƒ¼ã‚¿ã§ã™ã€‚\n"
    "ã“ã®ãƒ‡ãƒ¼ã‚¿ã®åˆ†æçµæœã‚’è¡¨ç¾ã™ã‚‹ã€\n"
    "15æ–‡å­—ç¨‹åº¦ã®ç°¡æ½”ãªã‚¿ã‚¤ãƒˆãƒ«ã‚’1ã¤ã ã‘ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚\n"
    "ã‚¿ã‚¤ãƒˆãƒ«ã®ã¿ã‚’å›ç­”ã—ã€èª¬æ˜æ–‡ã¯ä¸è¦ã§ã™ã€‚\n\n"
    "ã€ãƒˆãƒ¬ãƒ³ãƒ‰ãƒ‡ãƒ¼ã‚¿ï¼ˆDate, Valueï¼‰ã€‘:\n"
    f"{csv_data_for_prompt}"
)

# --- Geminiå®Ÿè¡Œãƒœã‚¿ãƒ³ ---
if st.button("ğŸ¤– Geminiã§ç¤ºå”†ã‚’ç”Ÿæˆ", type="primary"):
    with st.spinner("GeminiãŒåˆ†æä¸­..."):
        try:
            # ç¤ºå”†ã¨ã‚¿ã‚¤ãƒˆãƒ«ã‚’åŒæ™‚ã«ç”Ÿæˆ
            response = model.generate_content(prompt)
            insight = response.text.strip()
            
            title_response = model.generate_content(title_prompt)
            slide_title = title_response.text.strip()
            
            # çµæœè¡¨ç¤º
            st.success("âœ… Geminiã‹ã‚‰ã®ç¤ºå”†:")
            st.markdown(f"**{insight}**")
            st.success("âœ… ç”Ÿæˆã•ã‚ŒãŸã‚¿ã‚¤ãƒˆãƒ«:")
            st.markdown(f"**{slide_title}**")

            # â˜…â˜…â˜… ã“ã“ã‹ã‚‰PowerPointä½œæˆã®ãƒ–ãƒ­ãƒƒã‚¯ â˜…â˜…â˜…
            st.subheader("â‘¤ PowerPoint å‡ºåŠ›")
            
            with st.spinner("PowerPointã‚’ç”Ÿæˆä¸­..."):
                # ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€
                if not os.path.exists(PPTX_TEMPLATE_PATH):
                    st.error(f"ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: {PPTX_TEMPLATE_PATH}")
                    st.stop() # ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒãªã‘ã‚Œã°å‡¦ç†ã‚’åœæ­¢

                prs = Presentation(PPTX_TEMPLATE_PATH)

                # ã€é‡è¦ã€‘ã”è‡ªèº«ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«åˆã‚ã›ã¦ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆç•ªå·ã‚’èª¿æ•´ã—ã¦ãã ã•ã„
                # PowerPointã®ã€Œè¡¨ç¤ºã€>ã€Œã‚¹ãƒ©ã‚¤ãƒ‰ãƒã‚¹ã‚¿ãƒ¼ã€ã§ç¢ºèªã§ãã¾ã™ï¼ˆ0ã‹ã‚‰æ•°ãˆã¾ã™ï¼‰
                # ä¾‹ï¼š 0 = ã‚¿ã‚¤ãƒˆãƒ«ã‚¹ãƒ©ã‚¤ãƒ‰, 6 = ç©ºç™½ã®ã‚¹ãƒ©ã‚¤ãƒ‰
                TITLE_SLIDE_LAYOUT_INDEX = 0
                CONTENT_SLIDE_LAYOUT_INDEX = 6

                # --- 1æšç›®ã®ã‚¹ãƒ©ã‚¤ãƒ‰ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ã‚¹ãƒ©ã‚¤ãƒ‰ï¼‰ ---
                title_slide_layout = prs.slide_layouts[TITLE_SLIDE_LAYOUT_INDEX]
                slide = prs.slides.add_slide(title_slide_layout)

                # ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã«ãƒ†ã‚­ã‚¹ãƒˆã‚’æµã—è¾¼ã‚€
                slide.shapes.title.text = "çµŒæ¸ˆãƒ‡ãƒ¼ã‚¿åˆ†æãƒ¬ãƒãƒ¼ãƒˆ"
                if len(slide.placeholders) > 1:
                    slide.placeholders[1].text = f"åˆ†æå¯¾è±¡: {selected_filename}\nGeminiã«ã‚ˆã‚‹ç¤ºå”†ã‚’å«ã‚€"

                # --- 2æšç›®ã®ã‚¹ãƒ©ã‚¤ãƒ‰ï¼ˆå†…å®¹ã‚¹ãƒ©ã‚¤ãƒ‰ï¼‰ ---
                content_slide_layout = prs.slide_layouts[CONTENT_SLIDE_LAYOUT_INDEX]
                slide = prs.slides.add_slide(content_slide_layout)

                # ä¸Šéƒ¨ã«Geminiç”Ÿæˆã‚¿ã‚¤ãƒˆãƒ«ã‚’é…ç½®
                title_textbox = slide.shapes.add_textbox(Inches(0.5), Inches(0.2), Inches(9), Inches(0.8))
                title_text_frame = title_textbox.text_frame
                title_text_frame.clear()
                
                title_para = title_text_frame.add_paragraph()
                title_para.text = slide_title
                title_para.font.size = Pt(24)
                title_para.font.bold = True
                
                # ã‚¿ã‚¤ãƒˆãƒ«ä¸‹ã«ãƒªãƒ¼ãƒ‰æ–‡ã¨ã—ã¦ç¤ºå”†ã‚’é…ç½®
                textbox = slide.shapes.add_textbox(Inches(0.5), Inches(1.2), Inches(9), Inches(1.5))
                text_frame = textbox.text_frame
                text_frame.clear()
                
                lead_para = text_frame.add_paragraph()
                lead_para.text = insight
                lead_para.font.size = Pt(16)
                
                # ä¸‹éƒ¨ä¸­å¤®ã«ã‚°ãƒ©ãƒ•ã‚’é…ç½®
                graph_path = f"trend_plot_{selected_filename.replace('.csv', '')}.png"
                fig.savefig(graph_path, dpi=150, bbox_inches='tight')
                slide.shapes.add_picture(graph_path, Inches(1.5), Inches(3), width=Inches(7), height=Inches(4))

                # ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³
                pptx_filename = f"economic_insight_report_{selected_filename.replace('.csv', '')}.pptx"
                prs.save(pptx_filename)
                
                with open(pptx_filename, "rb") as f:
                    st.download_button(
                        "ğŸ“¥ PowerPointã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰",
                        data=f,
                        file_name=pptx_filename,
                        mime="application/vnd.openxmlformats-officedocument.presentationml.presentation",
                        type="primary"
                    )
                
                st.success(f"âœ… PowerPointãƒ•ã‚¡ã‚¤ãƒ«ã€Œ{pptx_filename}ã€ãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸï¼")

        except Exception as e:
            st.error(f"âŒ Gemini APIã¾ãŸã¯PowerPointç”Ÿæˆã‚¨ãƒ©ãƒ¼: {e}")

# --- ã‚µã‚¤ãƒ‰ãƒãƒ¼ã«è¿½åŠ æƒ…å ± ---
with st.sidebar:
    st.header("ğŸ“Š ã‚¢ãƒ—ãƒªæƒ…å ±")
    st.info(f"**æ¤œç´¢ãƒ•ã‚©ãƒ«ãƒ€:** {CSV_FOLDER}")
    
    # å…¨ä½“ã®ãƒ•ã‚¡ã‚¤ãƒ«æ•°ã‚’è¡¨ç¤º
    total_files = sum(len(files) for files in categorized_files.values())
    st.info(f"**åˆ©ç”¨å¯èƒ½ãƒ•ã‚¡ã‚¤ãƒ«æ•°:** {total_files}å€‹")
    
    # ã‚«ãƒ†ã‚´ãƒªåˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§
    if categorized_files:
        st.write("**ğŸ“ ã‚«ãƒ†ã‚´ãƒªåˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§:**")
        for category, filenames in categorized_files.items():
            st.write(f"**{category}** ({len(filenames)}å€‹)")
            for i, filename in enumerate(filenames, 1):
                if category == selected_category and filename == selected_filename:
                    st.write(f"   âœ… {i}. **{filename}** (é¸æŠä¸­)")
                else:
                    st.write(f"   {i}. {filename}")
            st.write("")  # ç©ºè¡Œã§ã‚«ãƒ†ã‚´ãƒªã‚’åŒºåˆ‡ã‚‹

# è¤‡åˆåˆ†æã®ãƒªãƒ¼ãƒ‰æ–‡ã®é…ç½®ï¼ˆimport streamlit as st
import streamlit as st
import pandas as pd
import matplotlib.pyplot as plt
import matplotlib.font_manager as fm
import numpy as np
import os
import glob
from pptx import Presentation
from pptx.util import Inches, Pt, Cm
from pptx.enum.text import PP_ALIGN
from pptx.enum.shapes import MSO_SHAPE
from pptx.dml.color import RGBColor
from datetime import datetime
import google.generativeai as genai

# è¨­å®šï¼ˆæœ€åˆã«é…ç½®ï¼‰
st.set_page_config(page_title="CSVåˆ†æã¨PPTè‡ªå‹•ç”Ÿæˆ", layout="wide")
st.title("CSVãƒ‡ãƒ¼ã‚¿åˆ†æ & Geminiç¤ºå”† & PowerPointå‡ºåŠ›")

# æ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆè¨­å®š
def setup_japanese_font():
    """æ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆã‚’è¨­å®š"""
    font_candidates = [
        'Yu Gothic',
        'Meiryo',
        'MS Gothic',
        'Hiragino Sans',
        'DejaVu Sans'
    ]
    
    available_fonts = [f.name for f in fm.fontManager.ttflist]
    
    for font_name in font_candidates:
        if font_name in available_fonts:
            plt.rcParams['font.family'] = font_name
            st.info(f"æ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆè¨­å®š: {font_name}")
            return font_name
    
    st.warning("æ—¥æœ¬èªå¯¾å¿œãƒ•ã‚©ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚°ãƒ©ãƒ•ã®æ—¥æœ¬èªãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚")
    return None

# æ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆè¨­å®šã‚’å®Ÿè¡Œ
setup_japanese_font()

# ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã®å®šç¾©
CSV_FOLDER = "C:\\Users\\shomatsubara\\Documents\\Python_project\\"
PPTX_TEMPLATE_PATH = "C:\\Users\\shomatsubara\\OneDrive - ABeam Consulting Ltd\\ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ\\æ–°äººç ”ä¿®\\ãƒ†ãƒ³ãƒ—ãƒ¬.pptx"

# CSVãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚«ãƒ†ã‚´ãƒªå®šç¾©
CSV_CATEGORIES = {
    "é‡‘è": [
        "ã‚³ãƒ¼ãƒ«å¸‚å ´çµ±è¨ˆï¼œæ—¥æœ¬éŠ€è¡Œï¼.csv",
        "ãƒãƒã‚¿ãƒªãƒ¼ãƒ™ãƒ¼ã‚¹å¹³å‡æ®‹é«˜.csv",
        "ãƒãƒãƒ¼ã‚¹ãƒˆãƒƒã‚¯çµ±è¨ˆï¼œæ—¥æœ¬éŠ€è¡Œï¼.csv",
        "å›½å†…ä¼æ¥­ç‰©ä¾¡æŒ‡æ•°ï¼ˆç·å¹³å‡ï¼‰2020å¹´åŸºæº–.csv",
        "è²¸å‡ºãƒ»é é‡‘å‹•å‘ï¼œæ—¥æœ¬éŠ€è¡Œï¼.csv",
        "çŸ­è¦³_boj.csv",
        "æ±è¨¼æ ªä¾¡æŒ‡æ•°ï¼ˆTOPIXï¼‰.csv",
        "è¼¸å…¥ç‰©ä¾¡æŒ‡æ•°ï¼ˆç·å¹³å‡ï¼‰ï¼ˆå††ãƒ™ãƒ¼ã‚¹ï¼‰2020å¹´åŸºæº–.csv",
        "è¼¸å‡ºç‰©ä¾¡æŒ‡æ•°ï¼ˆç·å¹³å‡ï¼‰ï¼ˆå††ãƒ™ãƒ¼ã‚¹ï¼‰2020å¹´åŸºæº–.csv"
    ],
    "ä¼æ¥­ãƒ»å®¶è¨ˆãƒ»çµŒæ¸ˆ": [
        "ä¼æ¥­ç­‰æ•°.csv",
        "æ™¯æ°—å‹•å‘æŒ‡æ•°ï¼ˆä¸€è‡´ï¼‰2015å¹´åŸºæº–.csv",
        "æ™¯æ°—å‹•å‘æŒ‡æ•°ï¼ˆä¸€è‡´ï¼‰2020å¹´åŸºæº–.csv",
        "æ¶ˆè²»è€…ç‰©ä¾¡æŒ‡æ•°ï¼ˆç·åˆï¼‰2015å¹´åŸºæº–.csv",
        "æ¶ˆè²»è€…ç‰©ä¾¡æŒ‡æ•°ï¼ˆç·åˆï¼‰2020å¹´åŸºæº–.csv",
        "å›½å†…ç·ç”Ÿç”£ï¼ˆæ”¯å‡ºå´ï¼‰ï¼ˆåç›®ï¼‰ï¼ˆç±³ãƒ‰ãƒ«è¡¨ç¤ºï¼‰.csv"
    ],
    "é‰±æ¥­": [
        "é‰±å·¥æ¥­ç”Ÿç”£æŒ‡æ•°ã€€2015å¹´åŸºæº–.csv",
        "é‰±å·¥æ¥­ç”Ÿç”£æŒ‡æ•°ã€€2020å¹´åŸºæº–.csv",
        "è£½é€ å·¥æ¥­ç”Ÿç”£èƒ½åŠ›æŒ‡æ•°ã€€2015å¹´åŸºæº–.csv",
        "è£½é€ å·¥æ¥­ç”Ÿç”£èƒ½åŠ›æŒ‡æ•°ã€€2020å¹´åŸºæº–.csv",
        "è£½é€ å·¥æ¥­ç¨¼åƒç‡æŒ‡æ•°ã€€2015å¹´åŸºæº–.csv",
        "è£½é€ å·¥æ¥­ç¨¼åƒç‡æŒ‡æ•°ã€€2020å¹´åŸºæº–.csv"
    ],
    "ä½å®…ãƒ»åœŸåœ°ãƒ»å»ºç‰©": [
        "ä½å®…æ•°.csv"
    ],
    "äººå£ãƒ»ä¸–å¸¯": [
        "ä¸–å¸¯æ•°ï¼ˆç·æ•°ï¼‰.csv",
        "å‡ºç”Ÿæ•°ï¼ˆå¤–å›½äººã‚’å«ã‚€ï¼‰.csv",
        "å‡ºç”Ÿç‡ï¼ˆäººå£åƒå¯¾ï¼‰.csv",
        "æ­»äº¡æ•°ï¼ˆå¤–å›½äººã‚’å«ã‚€ï¼‰.csv",
        "æ­»äº¡ç‡ï¼ˆäººå£åƒå¯¾ï¼‰.csv",
        "ç·äººå£ï¼ˆç·æ•°ï¼‰.csv"
    ],
    "åŠ´åƒãƒ»è³ƒé‡‘": [
        "å®Œå…¨å¤±æ¥­ç‡ï¼ˆç”·å¥³è¨ˆï¼‰.csv",
        "å®Ÿè³ªè³ƒé‡‘æŒ‡æ•°ï¼ˆç¾é‡‘çµ¦ä¸ç·é¡ï¼‰.csv",
        "å°±æ¥­ç‡ï¼ˆç·æ•°ï¼‰.csv",
        "å½¹å“¡ã‚’é™¤ãé›‡ç”¨è€…ã«å ã‚ã‚‹éæ­£è¦ã®è·å“¡ãƒ»å¾“æ¥­å“¡ã®å‰²åˆï¼ˆç”·å¥³è¨ˆï¼‰.csv",
        "æ­£è¦ã®è·å“¡ãƒ»å¾“æ¥­å“¡ï¼ˆç”·å¥³è¨ˆï¼‰.csv",
        "éæ­£è¦ã®è·å“¡ãƒ»å¾“æ¥­å“¡ï¼ˆç”·å¥³è¨ˆï¼‰.csv"
    ]
}

@st.cache_data
def get_categorized_csv_files(folder_path, categories):
    """ã‚«ãƒ†ã‚´ãƒªåˆ¥ã«CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ•´ç†"""
    try:
        csv_pattern = os.path.join(folder_path, "*.csv")
        all_csv_files = glob.glob(csv_pattern)
        all_csv_filenames = [os.path.basename(file) for file in all_csv_files]
        
        categorized_files = {}
        categorized_paths = {}
        
        for category, filenames in categories.items():
            category_files = []
            category_paths = []
            
            for filename in filenames:
                if filename in all_csv_filenames:
                    category_files.append(filename)
                    file_index = all_csv_filenames.index(filename)
                    category_paths.append(all_csv_files[file_index])
            
            if category_files:
                categorized_files[category] = category_files
                categorized_paths[category] = category_paths
        
        return categorized_files, categorized_paths, all_csv_filenames
    except Exception as e:
        st.error(f"CSVãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œç´¢ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}")
        return {}, {}, []

@st.cache_data
def load_csv_data(file_path):
    """CSVãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã€å‰å‡¦ç†ã‚’è¡Œã†"""
    try:
        df = pd.read_csv(file_path, encoding="utf-8")
        df.columns = df.columns.str.strip()
        
        if "timeCd" not in df.columns or "value" not in df.columns:
            return None, "CSVãƒ•ã‚¡ã‚¤ãƒ«ã« 'timeCd' ã¨ 'value' ã®åˆ—ãŒå¿…è¦ã§ã™ã€‚"
        
        df['timeCd'] = df['timeCd'].astype(str)
        df['Date'] = None
        
        mask_6digit = df['timeCd'].str.len() >= 6
        if mask_6digit.any():
            df.loc[mask_6digit, 'Date'] = pd.to_datetime(
                df.loc[mask_6digit, 'timeCd'].str[:6], 
                format='%Y%m', 
                errors='coerce'
            )
        
        mask_8digit = df['timeCd'].str.len() >= 8
        if mask_8digit.any():
            df.loc[mask_8digit & df['Date'].isna(), 'Date'] = pd.to_datetime(
                df.loc[mask_8digit & df['Date'].isna(), 'timeCd'].str[:8], 
                format='%Y%m%d', 
                errors='coerce'
            )
        
        mask_4digit = df['timeCd'].str.len() == 4
        if mask_4digit.any():
            df.loc[mask_4digit & df['Date'].isna(), 'Date'] = pd.to_datetime(
                df.loc[mask_4digit & df['Date'].isna(), 'timeCd'] + '01', 
                format='%Y%m', 
                errors='coerce'
            )
        
        initial_count = len(df)
        df = df.dropna(subset=['Date'])
        df = df.rename(columns={'value': 'Value'})
        
        df['Value'] = pd.to_numeric(df['Value'], errors='coerce')
        df = df.dropna(subset=['Value'])
        
        final_count = len(df)
        
        if final_count == 0:
            return None, "æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚æ—¥ä»˜å½¢å¼ã¾ãŸã¯æ•°å€¤å½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
        
        if final_count < initial_count * 0.5:
            warning_msg = f"æ³¨æ„: ãƒ‡ãƒ¼ã‚¿ã®{initial_count - final_count}è¡ŒãŒç„¡åŠ¹ãªå½¢å¼ã®ãŸã‚é™¤å¤–ã•ã‚Œã¾ã—ãŸã€‚"
            return df, warning_msg
        
        return df, None
    except Exception as e:
        return None, f"CSV èª­ã¿è¾¼ã¿å¤±æ•—: {e}"

def detect_sequential_significant_changes(df):
    """ç›´å‰ã®æ•°å€¤ã¨æ¯”è¼ƒã—ãŸéš›ã®å¤‰åŒ–ç‡ã§æœ€ã‚‚ä¸Šæ˜‡ãƒ»ä¸‹è½ã—ãŸç‚¹ã‚’æ¤œå‡ºï¼ˆä¸Šæ˜‡2ã¤ã€ä¸‹è½2ã¤ï¼‰"""
    if len(df) < 2:  # æœ€ä½2ã¤ã®ãƒ‡ãƒ¼ã‚¿ãŒå¿…è¦ï¼ˆç›´å‰æ¯”è¼ƒã®ãŸã‚ï¼‰
        return []
    
    # ãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦Dateåˆ—ã‚’ç¢ºå®Ÿã«datetimeå‹ã«ã™ã‚‹
    df_sorted = df.copy().sort_values('Date').reset_index(drop=True)
    
    # Dateåˆ—ãŒdatetimeå‹ã§ãªã„å ´åˆã¯å¤‰æ›ã‚’è©¦è¡Œ
    if not pd.api.types.is_datetime64_any_dtype(df_sorted['Date']):
        try:
            df_sorted['Date'] = pd.to_datetime(df_sorted['Date'])
        except:
            return []  # å¤‰æ›ã§ããªã„å ´åˆã¯å¤‰åŒ–ç‚¹æ¤œå‡ºã‚’ã‚¹ã‚­ãƒƒãƒ—
    
    sequential_changes = []
    
    for i in range(1, len(df_sorted)):  # 2ç•ªç›®ã®è¦ç´ ã‹ã‚‰é–‹å§‹
        current_date = df_sorted.iloc[i]['Date']
        current_value = df_sorted.iloc[i]['Value']
        
        # ç›´å‰ã®å€¤ã‚’å–å¾—
        prev_value = df_sorted.iloc[i-1]['Value']
        prev_date = df_sorted.iloc[i-1]['Date']
        
        # ç›´å‰ã¨ã®å¤‰åŒ–ç‡ã‚’è¨ˆç®—
        if prev_value != 0:
            change_rate = ((current_value - prev_value) / prev_value) * 100
            
            sequential_changes.append({
                'index': i,
                'date': current_date,
                'value': current_value,
                'prev_date': prev_date,
                'prev_value': prev_value,
                'change_rate': change_rate
            })
    
    if not sequential_changes:
        return []
    
    # ç›´å‰æ¯”å¤‰åŒ–ç‡ã§ã‚½ãƒ¼ãƒˆ
    sequential_changes_sorted = sorted(sequential_changes, key=lambda x: x['change_rate'])
    
    # æœ€ã‚‚ä¸‹è½ã—ãŸ2ã¤ï¼ˆè² ã®å¤‰åŒ–ç‡ãŒå¤§ãã„ï¼‰
    top_declines = [change for change in sequential_changes_sorted if change['change_rate'] < 0][:2]
    
    # æœ€ã‚‚ä¸Šæ˜‡ã—ãŸ2ã¤ï¼ˆæ­£ã®å¤‰åŒ–ç‡ãŒå¤§ãã„ï¼‰
    top_increases = [change for change in sequential_changes_sorted if change['change_rate'] > 0][-2:]
    
    # ä¸‹è½ã¨ä¸Šæ˜‡ã‚’åˆã‚ã›ã¦æœ€å¤§4ã¤
    significant_changes = top_declines + top_increases
    
    # ãƒ‡ãƒ¼ã‚¿ãŒå°‘ãªã„å ´åˆã¯ã€å¤‰åŒ–ç‡ã®çµ¶å¯¾å€¤ãŒå¤§ãã„é †ã«æœ€å¤§4ã¤é¸æŠ
    if len(significant_changes) < 4:
        all_changes_by_abs = sorted(sequential_changes, key=lambda x: abs(x['change_rate']), reverse=True)
        significant_changes = all_changes_by_abs[:4]
    
    return significant_changes

def generate_sequential_change_reason(date, value, prev_value, change_rate, filename, model):
    """ç›´å‰æ¯”å¤‰åŒ–ã®ç†ç”±ã‚’ç”Ÿæˆã™ã‚‹ï¼ˆ30æ–‡å­—ä»¥å†…ã€æ–­è¨€èª¿ï¼‰"""
    # dateãŒdatetimeå‹ã§ãªã„å ´åˆã®å‡¦ç†
    if pd.api.types.is_datetime64_any_dtype(pd.Series([date])):
        year = date.year
        month = date.month
    else:
        try:
            date_converted = pd.to_datetime(date)
            year = date_converted.year
            month = date_converted.month
        except:
            year = "ä¸æ˜"
            month = "ä¸æ˜"
    
    # ä¸Šæ˜‡ãƒ»ä¸‹è½ã®åˆ¤å®š
    change_direction = "ä¸Šæ˜‡" if change_rate > 0 else "ä¸‹è½"
    
    prompt = (
        f"ãƒ‡ãƒ¼ã‚¿: {filename}\n"
        f"æ™‚æœŸ: {year}å¹´{month}æœˆ\n"
        f"ç¾åœ¨å€¤: {value:.2f}\n"
        f"ç›´å‰å€¤: {prev_value:.2f}\n"
        f"ç›´å‰æ¯”å¤‰åŒ–ç‡: {change_rate:+.1f}%ï¼ˆ{change_direction}ï¼‰\n\n"
        f"ã“ã®æ™‚æœŸã«{filename.replace('.csv', '')}ã§ç›´å‰æ¯”{change_rate:+.1f}%ã®{change_direction}ãŒç™ºç”Ÿã—ãŸç†ç”±ã‚’ã€"
        f"30æ–‡å­—ä»¥å†…ã§æ–­è¨€èª¿ï¼ˆï½ã ã€ï½ã§ã‚ã‚‹ã€ï½ã—ãŸï¼‰ã§çµ‚ã‚ã‚‹å½¢ã§å…·ä½“çš„ã«èª¬æ˜ã—ã¦ãã ã•ã„ã€‚"
        f"æ­´å²çš„äº‹å®Ÿã‚„çµŒæ¸ˆè¦å› ã‚’è€ƒæ…®ã—ã¦ãã ã•ã„ã€‚æ–‡å­—æ•°ã¯è¡¨ç¤ºã—ãªã„ã§ãã ã•ã„ã€‚"
    )
    
    try:
        response = model.generate_content(prompt)
        reason = response.text.strip()
        # 30æ–‡å­—åˆ¶é™ã‚’ç¢ºå®Ÿã«ã™ã‚‹
        if len(reason) > 30:
            reason = reason[:30]
        # æ–­è¨€èª¿ã®æ–‡æœ«å½¢å¼ã§ãªã„å ´åˆã¯èª¿æ•´
        if not (reason.endswith('ã ') or reason.endswith('ã§ã‚ã‚‹') or reason.endswith('ã—ãŸ') or reason.endswith('ãŸ')):
            # å‹•è©ã‚„å½¢å®¹è©ã®èªå¹¹ã‹ã‚‰é©åˆ‡ãªæ–­è¨€èª¿ã‚’é¸æŠ
            if 'ã—' in reason or 'å¤‰åŒ–' in reason or 'å½±éŸ¿' in reason:
                if len(reason) <= 28:
                    reason = reason + "ã—ãŸ"
                else:
                    reason = reason[:28] + "ã—ãŸ"
            elif 'è¦å› ' in reason or 'ç†ç”±' in reason or 'èƒŒæ™¯' in reason:
                if len(reason) <= 27:
                    reason = reason + "ã§ã‚ã‚‹"
                else:
                    reason = reason[:27] + "ã§ã‚ã‚‹"
            else:
                if len(reason) <= 29:
                    reason = reason + "ã "
                else:
                    reason = reason[:29] + "ã "
        return reason
    except Exception as e:
        direction_text = "ä¸Šæ˜‡" if change_rate > 0 else "ä¸‹è½"
        return f"{year}å¹´{month}æœˆã®{direction_text}è¦å› ã "

def calculate_optimal_callout_position(point_x, point_y, used_positions, graph_bounds):
    """
    æ³¨ç›®ãƒã‚¤ãƒ³ãƒˆã®è¿‘ãã«é•·æ–¹å½¢ã‚’é…ç½®ã—ã€ç›´ç·šã§çµã¶ãŸã‚ã®æœ€é©ä½ç½®ã‚’è¨ˆç®—
    
    Args:
        point_x, point_y: æ³¨ç›®ãƒã‚¤ãƒ³ãƒˆã®åº§æ¨™(cm)
        used_positions: æ—¢ã«ä½¿ç”¨ã•ã‚Œã¦ã„ã‚‹é•·æ–¹å½¢ã®ä½ç½®ãƒªã‚¹ãƒˆ
        graph_bounds: ã‚°ãƒ©ãƒ•ã®å¢ƒç•Œ {'left': x, 'top': y, 'right': x, 'bottom': y}
    
    Returns:
        æœ€é©ãªé•·æ–¹å½¢ã®åº§æ¨™ (x, y)
    """
    # é•·æ–¹å½¢ã®ã‚µã‚¤ã‚º
    rect_width = 4.0
    rect_height = 1.2
    # æ³¨ç›®ãƒã‚¤ãƒ³ãƒˆã‹ã‚‰ã®è·é›¢ã‚’çŸ­ãè¨­å®šï¼ˆè¿‘ãã«é…ç½®ï¼‰
    base_distance = 1.5  # åŸºæœ¬è·é›¢(cm) - å›³ã®ã‚ˆã†ã«è¿‘ãã«é…ç½®
    margin = 0.3  # ä»–ã®é•·æ–¹å½¢ã¨ã®æœ€å°é–“éš”(cm)
    
    # å›³ã®ã‚ˆã†ãªé…ç½®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã®å€™è£œä½ç½®
    import math
    candidates = []
    
    # ã‚ˆã‚Šç´°ã‹ã„è§’åº¦ã§å€™è£œã‚’ç”Ÿæˆï¼ˆ24æ–¹å‘ï¼‰
    angles = [i * 15 for i in range(24)]  # 0Â°, 15Â°, 30Â°, 45Â°, ... 345Â°
    
    for angle in angles:
        # è·é›¢ã‚’æ®µéšçš„ã«å¤‰åŒ–ã•ã›ã¦ã€ã‚ˆã‚Šè¿‘ã„ä½ç½®ã‹ã‚‰é ã„ä½ç½®ã¾ã§è©¦è¡Œ
        for distance in [1.2, 1.5, 2.0, 2.5]:
            rad = math.radians(angle)
            candidate_x = point_x + distance * math.cos(rad)
            candidate_y = point_y + distance * math.sin(rad)
            
            # é•·æ–¹å½¢ã®å·¦ä¸Šè§’åº§æ¨™ã«èª¿æ•´
            rect_x = candidate_x - rect_width / 2
            rect_y = candidate_y - rect_height / 2
            
            # å›³ã®ã‚ˆã†ãªé…ç½®ã‚’å„ªå…ˆï¼ˆå³ä¸Šã€å³ä¸‹ã€å·¦ä¸Šã€å·¦ä¸‹ã®é †ï¼‰
            if 0 <= angle <= 90:        # å³ä¸Šè±¡é™
                priority = 1
            elif 270 <= angle <= 360:   # å³ä¸‹è±¡é™
                priority = 2
            elif 90 <= angle <= 180:    # å·¦ä¸Šè±¡é™
                priority = 3
            else:                       # å·¦ä¸‹è±¡é™
                priority = 4
            
            candidates.append({
                'x': rect_x,
                'y': rect_y,
                'center_x': candidate_x,
                'center_y': candidate_y,
                'distance': distance,
                'angle': angle,
                'priority': priority
            })
    
    # å„ªå…ˆé †ä½ã¨è·é›¢ã§ã‚½ãƒ¼ãƒˆï¼ˆè¿‘ã„ä½ç½®ã‚’å„ªå…ˆï¼‰
    candidates.sort(key=lambda c: (c['priority'], c['distance'], abs(c['angle'] - 45)))
    
    def is_position_valid(x, y):
        """ä½ç½®ãŒæœ‰åŠ¹ã‹ã©ã†ã‹ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆåˆ¶ç´„ã‚’ç·©å’Œï¼‰"""
        rect_right = x + rect_width
        rect_bottom = y + rect_height
        
        # 1. ã‚¹ãƒ©ã‚¤ãƒ‰å¢ƒç•Œãƒã‚§ãƒƒã‚¯ï¼ˆPowerPointã‚¹ãƒ©ã‚¤ãƒ‰ã‚µã‚¤ã‚ºå†…ï¼‰
        slide_width = 33.867  # PowerPointã‚¹ãƒ©ã‚¤ãƒ‰å¹…(cm)
        slide_height = 19.05  # PowerPointã‚¹ãƒ©ã‚¤ãƒ‰é«˜ã•(cm)
        
        if x < 0 or y < 0 or rect_right > slide_width or rect_bottom > slide_height:
            return False
        
        # 2. æ—¢å­˜ã®é•·æ–¹å½¢ã¨ã®é‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼ˆé–“éš”ã‚’çŸ­ç¸®ï¼‰
        for used_pos in used_positions:
            used_right = used_pos['x'] + rect_width + margin
            used_bottom = used_pos['y'] + rect_height + margin
            
            if not (rect_right < used_pos['x'] - margin or 
                    x > used_right or 
                    rect_bottom < used_pos['y'] - margin or 
                    y > used_bottom):
                return False
        
        # 3. ã‚°ãƒ©ãƒ•ã¨ã®é‡è¤‡ã¯è¨±å¯ï¼ˆå›³ã®ã‚ˆã†ã«é‡è¤‡OKï¼‰
        return True
    
    # æœ€é©ãªä½ç½®ã‚’æ¢ç´¢
    for candidate in candidates:
        if is_position_valid(candidate['x'], candidate['y']):
            return candidate['x'], candidate['y']
    
    # å…¨ã¦ã®å€™è£œãŒãƒ€ãƒ¡ãªå ´åˆã¯ã€æ³¨ç›®ãƒã‚¤ãƒ³ãƒˆã®å³ä¸Šã«å¼·åˆ¶é…ç½®
    fallback_x = point_x + 1.0
    fallback_y = point_y - 1.0
    return fallback_x, fallback_y

def add_callout_with_connector(slide, point_x, point_y, callout_x, callout_y, text):
    """æ³¨ç›®ãƒã‚¤ãƒ³ãƒˆã¨é•·æ–¹å½¢å›³å½¢ã‚’ç›´ç·šã§çµã¶å¹ãå‡ºã—ã‚’è¿½åŠ ï¼ˆå›³ã®å½¢å¼ã«æº–æ‹ ï¼‰"""
    # é•·æ–¹å½¢ã®ä¸­å¿ƒåº§æ¨™ã‚’è¨ˆç®—
    rect_center_x = callout_x + 2.0  # é•·æ–¹å½¢ã®å¹…4cmã®ä¸­å¿ƒ
    rect_center_y = callout_y + 0.6  # é•·æ–¹å½¢ã®é«˜ã•1.2cmã®ä¸­å¿ƒ
    
    # 1. æ¥ç¶šç·šã‚’è¿½åŠ ï¼ˆæ³¨ç›®ãƒã‚¤ãƒ³ãƒˆã‹ã‚‰é•·æ–¹å½¢ã®ä¸­å¿ƒã¸ç›´ç·šï¼‰
    connector = slide.shapes.add_connector(
        1,  # MSO_CONNECTOR_TYPE.STRAIGHT
        Cm(point_x), Cm(point_y),  # é–‹å§‹ç‚¹ï¼ˆæ³¨ç›®ãƒã‚¤ãƒ³ãƒˆï¼‰
        Cm(rect_center_x), Cm(rect_center_y)  # çµ‚äº†ç‚¹ï¼ˆé•·æ–¹å½¢ã®ä¸­å¿ƒï¼‰
    )
    
    # ç·šã®æ›¸å¼è¨­å®šï¼ˆå›³ã«åˆã‚ã›ã¦èª¿æ•´ï¼‰
    line = connector.line
    line.color.rgb = RGBColor(255, 0, 0)  # èµ¤è‰²
    line.width = Pt(1.0)  # ç·šã®å¤ªã•ã‚’ç´°ãèª¿æ•´
    
    # 2. é•·æ–¹å½¢å›³å½¢ã‚’è¿½åŠ 
    rectangle = slide.shapes.add_shape(
        MSO_SHAPE.RECTANGLE,
        Cm(callout_x), Cm(callout_y),
        Cm(4), Cm(1.2)  # å¹…4cmã€é«˜ã•1.2cm
    )
    
    # é•·æ–¹å½¢ã®æ›¸å¼è¨­å®šï¼ˆå›³ã«åˆã‚ã›ã¦èª¿æ•´ï¼‰
    fill = rectangle.fill
    fill.solid()
    fill.fore_color.rgb = RGBColor(255, 255, 224)  # è–„ã„é»„è‰²
    
    line = rectangle.line
    line.color.rgb = RGBColor(255, 0, 0)  # èµ¤ã„æ ç·š
    line.width = Pt(1)
    
    # 3. ãƒ†ã‚­ã‚¹ãƒˆã‚’è¿½åŠ ï¼ˆç·¨é›†å¯èƒ½ã€é»’æ–‡å­—ï¼‰
    text_frame = rectangle.text_frame
    text_frame.clear()
    text_frame.margin_left = Cm(0.1)
    text_frame.margin_right = Cm(0.1)
    text_frame.margin_top = Cm(0.1)
    text_frame.margin_bottom = Cm(0.1)
    
    # ãƒ†ã‚­ã‚¹ãƒˆã®è¨­å®šï¼ˆé»’æ–‡å­—æŒ‡å®šï¼‰
    paragraph = text_frame.paragraphs[0]
    paragraph.text = text
    paragraph.font.size = Pt(9)  # ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’å°‘ã—å°ã•ã
    paragraph.font.bold = True
    paragraph.font.color.rgb = RGBColor(0, 0, 0)  # é»’è‰²æŒ‡å®š
    paragraph.alignment = PP_ALIGN.CENTER
    
    # é•·æ–¹å½¢ã‚’æœ€å‰é¢ã«é…ç½®ï¼ˆæ¥ç¶šç·šã®ä¸Šã«è¡¨ç¤ºï¼‰
    rectangle_element = rectangle._element
    slide_shapes = slide.shapes._spTree
    slide_shapes.remove(rectangle_element)
    slide_shapes.append(rectangle_element)
    
    return rectangle, connector

def create_editable_graph(df, filename, year_range=None, highlight_changes=True, model=None):
    """ç·¨é›†å¯èƒ½ãªã‚°ãƒ©ãƒ•ã‚’ä½œæˆï¼ˆå‰å¹´åŒæœˆæ¯”å¤‰åŒ–ç‚¹å¯¾å¿œï¼‰"""
    # ãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ”ãƒ¼
    df_plot = df.copy()
    
    # Dateåˆ—ãŒdatetimeå‹ã§ãªã„å ´åˆã¯å¤‰æ›ã‚’è©¦è¡Œ
    if not pd.api.types.is_datetime64_any_dtype(df_plot['Date']):
        try:
            df_plot['Date'] = pd.to_datetime(df_plot['Date'])
        except Exception as e:
            st.error(f"æ—¥ä»˜ãƒ‡ãƒ¼ã‚¿ã®å¤‰æ›ã«å¤±æ•—ã—ã¾ã—ãŸ: {e}")
            return None, None, []
    
    # æ—¥ä»˜ã§ã‚½ãƒ¼ãƒˆ
    df_plot = df_plot.sort_values('Date')
    
    # å¹´åº¦ç¯„å›²ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    if year_range and len(year_range) == 2:
        start_year, end_year = year_range
        try:
            mask = (df_plot['Date'].dt.year >= start_year) & (df_plot['Date'].dt.year <= end_year)
            df_filtered = df_plot[mask]
            
            if len(df_filtered) > 0:
                df_plot = df_filtered
        except Exception as e:
            st.warning(f"å¹´åº¦ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã§ã‚¨ãƒ©ãƒ¼: {e}")
    
    graph_title = f"{filename.replace('.csv', '')} - çµŒæ¸ˆå‹•å‘åˆ†æ"
    if year_range:
        graph_title += f" ({year_range[0]}å¹´-{year_range[1]}å¹´)"
    
    # ã‚¿ã‚¤ãƒˆãƒ«ã¨è»¸ãƒ©ãƒ™ãƒ«ã‚’å‰Šé™¤ã—ã¦ã‚·ãƒ³ãƒ—ãƒ«ãªã‚°ãƒ©ãƒ•ã‚’ä½œæˆ
    fig, ax = plt.subplots(figsize=(14, 8))
    
    # åŸºæœ¬çš„ãªç·šã‚°ãƒ©ãƒ•ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ã¨è»¸ãƒ©ãƒ™ãƒ«ãªã—ï¼‰
    ax.plot(df_plot['Date'], df_plot['Value'], marker='o', linewidth=2.5, markersize=5, color='blue', alpha=0.8)
    
    # ç›´å‰æ¯”å¤‰åŒ–ç‚¹ã®å¼·èª¿è¡¨ç¤ºï¼ˆå¹ãå‡ºã—ãªã—ï¼‰
    change_reasons = []
    if highlight_changes and model:
        significant_changes = detect_sequential_significant_changes(df_plot)
        
        for change in significant_changes:
            # èµ¤ã„ä¸¸ã§å¼·èª¿ï¼ˆå¹ãå‡ºã—ãªã—ï¼‰
            ax.scatter(change['date'], change['value'], color='red', s=150, zorder=5, alpha=0.8)
            ax.scatter(change['date'], change['value'], color='red', s=80, zorder=6)
            
            # ç›´å‰æ¯”å¤‰åŒ–ç†ç”±ã‚’ç”Ÿæˆã—ã¦ãƒªã‚¹ãƒˆã«ä¿å­˜
            reason = generate_sequential_change_reason(
                change['date'], 
                change['value'], 
                change['prev_value'],
                change['change_rate'],
                filename, 
                model
            )
            change_reasons.append({
                'date': change['date'],
                'value': change['value'],
                'reason': reason,
                'change_rate': change['change_rate']
            })
    
    # ã‚¿ã‚¤ãƒˆãƒ«ã¨è»¸ãƒ©ãƒ™ãƒ«ã‚’å‰Šé™¤
    ax.set_title("")
    ax.set_xlabel("")
    ax.set_ylabel("")
    ax.grid(True, alpha=0.3)
    
    # Xè»¸ã®è¡¨ç¤ºã‚’èª¿æ•´ï¼ˆãƒ©ãƒ™ãƒ«ã¯æ®‹ã™ï¼‰
    try:
        if len(df_plot) > 20:
            ax.tick_params(axis='x', rotation=45, labelsize=12)
            years = df_plot['Date'].dt.year.unique()
            if len(years) > 10:
                year_ticks = [y for y in years if y % 3 == 0]
            else:
                year_ticks = years
            
            year_dates = []
            for year in year_ticks:
                year_data = df_plot[df_plot['Date'].dt.year == year]
                if len(year_data) > 0:
                    year_dates.append(year_data['Date'].iloc[0])
            
            if year_dates:
                ax.set_xticks(year_dates)
                ax.set_xticklabels([f"{date.year}" for date in year_dates])
        else:
            plt.xticks(rotation=45, fontsize=12)
    except Exception as e:
        plt.xticks(rotation=45, fontsize=12)
    
    plt.yticks(fontsize=12)
    plt.tight_layout()
    
    return fig, graph_title, change_reasons

def create_graph(df, filename, year_range=None, highlight_changes=True, model=None):
    """è¡¨ç¤ºç”¨ã‚°ãƒ©ãƒ•ã‚’ä½œæˆï¼ˆå‰å¹´åŒæœˆæ¯”å¤‰åŒ–ç‚¹å¯¾å¿œï¼‰"""
    # ãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ”ãƒ¼
    df_plot = df.copy()
    
    # Dateåˆ—ãŒdatetimeå‹ã§ãªã„å ´åˆã¯å¤‰æ›ã‚’è©¦è¡Œ
    if not pd.api.types.is_datetime64_any_dtype(df_plot['Date']):
        try:
            df_plot['Date'] = pd.to_datetime(df_plot['Date'])
        except Exception as e:
            st.error(f"æ—¥ä»˜ãƒ‡ãƒ¼ã‚¿ã®å¤‰æ›ã«å¤±æ•—ã—ã¾ã—ãŸ: {e}")
            return None, None
    
    # æ—¥ä»˜ã§ã‚½ãƒ¼ãƒˆ
    df_plot = df_plot.sort_values('Date')
    
    # å¹´åº¦ç¯„å›²ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    if year_range and len(year_range) == 2:
        start_year, end_year = year_range
        try:
            mask = (df_plot['Date'].dt.year >= start_year) & (df_plot['Date'].dt.year <= end_year)
            df_filtered = df_plot[mask]
            
            if len(df_filtered) > 0:
                df_plot = df_filtered
        except Exception as e:
            st.warning(f"å¹´åº¦ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã§ã‚¨ãƒ©ãƒ¼: {e}")
    
    graph_title = f"{filename.replace('.csv', '')} - çµŒæ¸ˆå‹•å‘åˆ†æ"
    if year_range:
        graph_title += f" ({year_range[0]}å¹´-{year_range[1]}å¹´)"
    
    fig, ax = plt.subplots(figsize=(14, 8))
    
    # åŸºæœ¬çš„ãªç·šã‚°ãƒ©ãƒ•
    ax.plot(df_plot['Date'], df_plot['Value'], marker='o', linewidth=2.5, markersize=5, color='blue', alpha=0.8)
    
    # ç›´å‰æ¯”å¤‰åŒ–ç‚¹ã®å¼·èª¿è¡¨ç¤ºï¼ˆå¹ãå‡ºã—ä»˜ãï¼‰
    if highlight_changes and model:
        significant_changes = detect_sequential_significant_changes(df_plot)
        
        for change in significant_changes:
            # èµ¤ã„ä¸¸ã§å¼·èª¿ï¼ˆã‚ˆã‚Šç›®ç«‹ã¤ã‚ˆã†ã«ï¼‰
            ax.scatter(change['date'], change['value'], color='red', s=200, zorder=5, alpha=0.9, edgecolors='darkred', linewidth=2)
            ax.scatter(change['date'], change['value'], color='red', s=100, zorder=6)
            
            # ç›´å‰æ¯”å¤‰åŒ–ç†ç”±ã‚’ç”Ÿæˆ
            reason = generate_sequential_change_reason(
                change['date'], 
                change['value'], 
                change['prev_value'],
                change['change_rate'],
                filename, 
                model
            )
            
            # ç›´å‰æ¯”æƒ…å ±ã‚’å«ã‚€å¹ãå‡ºã—ã®è¿½åŠ ï¼ˆã‚ˆã‚Šè¦‹ã‚„ã™ãï¼‰
            change_text = f"{reason}\n(ç›´å‰æ¯”: {change['change_rate']:+.1f}%)"
            ax.annotate(change_text, 
                       xy=(change['date'], change['value']), 
                       xytext=(30, 30), 
                       textcoords='offset points',
                       bbox=dict(boxstyle='round,pad=0.4', facecolor='yellow', alpha=0.8, edgecolor='red'),
                       arrowprops=dict(arrowstyle='->', connectionstyle='arc3,rad=0.3', color='red', lw=1.5),
                       fontsize=10,
                       ha='left',
                       weight='bold')
    
    ax.set_title(graph_title, fontsize=18, pad=25)
    ax.set_xlabel("å¹´æœˆ", fontsize=14)
    ax.set_ylabel("æ•°å€¤", fontsize=14)
    ax.grid(True, alpha=0.3)
    
    # Xè»¸ã®è¡¨ç¤ºã‚’èª¿æ•´
    try:
        if len(df_plot) > 20:
            ax.tick_params(axis='x', rotation=45, labelsize=12)
            years = df_plot['Date'].dt.year.unique()
            if len(years) > 10:
                year_ticks = [y for y in years if y % 3 == 0]
            else:
                year_ticks = years
            
            year_dates = []
            for year in year_ticks:
                year_data = df_plot[df_plot['Date'].dt.year == year]
                if len(year_data) > 0:
                    year_dates.append(year_data['Date'].iloc[0])
            
            if year_dates:
                ax.set_xticks(year_dates)
                ax.set_xticklabels([f"{date.year}å¹´" for date in year_dates])
        else:
            plt.xticks(rotation=45, fontsize=12)
    except Exception as e:
        plt.xticks(rotation=45, fontsize=12)
    
    plt.yticks(fontsize=12)
    plt.tight_layout()
    
    return fig, graph_title

def create_composite_graph(analysis_results, year_range=None):
    """è¤‡æ•°ãƒ‡ãƒ¼ã‚¿ã®è¤‡åˆã‚°ãƒ©ãƒ•ã‚’ä½œæˆï¼ˆå˜ä¸€ã‚°ãƒ©ãƒ•ã¨åŒã˜å½¢å¼ï¼‰"""
    fig, ax = plt.subplots(figsize=(14, 8))
    
    colors = plt.cm.tab10(range(len(analysis_results)))
    
    for i, result in enumerate(analysis_results):
        df = result['df'].copy()
        label = result['filename'].replace('.csv', '').replace('ï¼œæ—¥æœ¬éŠ€è¡Œï¼', '').strip()
        
        # å¹´åº¦ç¯„å›²ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        if year_range and len(year_range) == 2:
            start_year, end_year = year_range
            try:
                # Dateåˆ—ãŒdatetimeå‹ã§ãªã„å ´åˆã¯å¤‰æ›ã‚’è©¦è¡Œ
                if not pd.api.types.is_datetime64_any_dtype(df['Date']):
                    df['Date'] = pd.to_datetime(df['Date'])
                
                mask = (df['Date'].dt.year >= start_year) & (df['Date'].dt.year <= end_year)
                df_filtered = df[mask]
                
                if len(df_filtered) > 0:
                    df = df_filtered
            except Exception as e:
                pass  # ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã¯ãã®ã¾ã¾é€²ã‚€
        
        # æ­£è¦åŒ–
        normalized_values = (df['Value'] - df['Value'].min()) / (df['Value'].max() - df['Value'].min())
        
        ax.plot(df['Date'], normalized_values, 
                marker='o', linewidth=2.5, markersize=4, 
                color=colors[i], label=label, alpha=0.8)
    
    # ã‚¿ã‚¤ãƒˆãƒ«ã¨è»¸ãƒ©ãƒ™ãƒ«ã‚’å‰Šé™¤ï¼ˆå˜ä¸€ã‚°ãƒ©ãƒ•ã¨åŒã˜ï¼‰
    ax.set_title("")
    ax.set_xlabel("")
    ax.set_ylabel("")
    ax.grid(True, alpha=0.3)
    # å‡¡ä¾‹ã‚‚å‰Šé™¤
    # ax.legend(bbox_to_anchor=(1.05, 1), loc='upper left', fontsize=10)
    plt.xticks(rotation=45, fontsize=12)
    plt.yticks(fontsize=12)
    plt.tight_layout()
    
    return fig

def generate_ai_insights(df, filename, model):
    """AIç¤ºå”†ã¨ã‚¿ã‚¤ãƒˆãƒ«ã‚’ç”Ÿæˆ"""
    csv_data_for_prompt = (
        df.sort_values("Date")[["Date", "Value"]]
        .tail(100)
        .to_string(index=False)
    )
    
    date_min = df['Date'].min()
    date_max = df['Date'].max()
    date_range_text = ""
    if pd.notna(date_min) and pd.notna(date_max):
        date_range_text = f"- æœŸé–“: {date_min.strftime('%Yå¹´%mæœˆ')} ï½ {date_max.strftime('%Yå¹´%mæœˆ')}\n"
    else:
        date_range_text = "- æœŸé–“: æ—¥ä»˜æƒ…å ±ãŒä¸å®Œå…¨\n"
    
    prompt = (
        f"ãƒ•ã‚¡ã‚¤ãƒ«å: {filename}\n\n"
        "ä»¥ä¸‹ã¯æ™‚ç³»åˆ—ã®çµŒæ¸ˆãƒ‡ãƒ¼ã‚¿ã§ã™ã€‚\n"
        "ã‚°ãƒ©ãƒ•ã‚’åˆ†æã—ã€ä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼š\n"
        "1. ãƒˆãƒ¬ãƒ³ãƒ‰ã®è¦ç‚¹ã‚’æ•´ç†ã—ã€ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ãä»Šå¾Œã®çµŒæ¸ˆå½±éŸ¿ã‚’äºˆæ¸¬ã—ã¦ãã ã•ã„ã€‚80æ–‡å­—ä»¥ä¸Š100æ–‡å­—ä»¥å†…ã§æ–­è¨€èª¿ï¼ˆã€œã ã€ã€œã§ã‚ã‚‹ï¼‰ã§è¨˜è¿°ã—ã€æ–‡å­—æ•°ã¯è¡¨ç¤ºã—ãªã„ã§ãã ã•ã„ã€‚\n\n"
        f"ãƒ‡ãƒ¼ã‚¿çµ±è¨ˆ:\n"
        f"{date_range_text}"
        f"- æœ€å¤§å€¤: {df['Value'].max():.2f}\n"
        f"- æœ€å°å€¤: {df['Value'].min():.2f}\n"
        f"- å¹³å‡å€¤: {df['Value'].mean():.2f}\n\n"
        "ã€ãƒˆãƒ¬ãƒ³ãƒ‰ãƒ‡ãƒ¼ã‚¿ï¼ˆDate, Valueï¼‰ã€‘:\n"
        f"{csv_data_for_prompt}"
    )
    
    title_prompt = (
        f"ãƒ•ã‚¡ã‚¤ãƒ«å: {filename}\n\n"
        "ä»¥ä¸‹ã¯æ™‚ç³»åˆ—ã®çµŒæ¸ˆãƒ‡ãƒ¼ã‚¿ã§ã™ã€‚\n"
        "ã“ã®ãƒ‡ãƒ¼ã‚¿ã®åˆ†æçµæœã‚’è¡¨ç¾ã™ã‚‹ã€15æ–‡å­—ç¨‹åº¦ã®ç°¡æ½”ãªã‚¿ã‚¤ãƒˆãƒ«ã‚’1ã¤ã ã‘ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚\n"
        "ã‚¿ã‚¤ãƒˆãƒ«ã®ã¿ã‚’å›ç­”ã—ã€èª¬æ˜æ–‡ã¯ä¸è¦ã§ã™ã€‚\n\n"
        "ã€ãƒˆãƒ¬ãƒ³ãƒ‰ãƒ‡ãƒ¼ã‚¿ï¼ˆDate, Valueï¼‰ã€‘:\n"
        f"{csv_data_for_prompt}"
    )
    
    try:
        response = model.generate_content(prompt)
        insight = response.text.strip()
        
        title_response = model.generate_content(title_prompt)
        slide_title = title_response.text.strip()
        
        return insight, slide_title
    except Exception as e:
        return f"AIåˆ†æã‚¨ãƒ©ãƒ¼: {e}", f"ãƒ‡ãƒ¼ã‚¿åˆ†æ_{filename.replace('.csv', '')}"

def generate_composite_insights(analysis_results, model, year_range=None):
    """è¤‡åˆã‚°ãƒ©ãƒ•ã‹ã‚‰ã®ç¤ºå”†ã‚’ç”Ÿæˆï¼ˆå˜ä¸€ã‚°ãƒ©ãƒ•ã¨åŒã˜ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ»æ–‡å­—åˆ¶é™ï¼‰"""
    data_summary = []
    for result in analysis_results:
        df = result['df'].copy()
        filename = result['filename']
        
        # å¹´åº¦ç¯„å›²ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        if year_range and len(year_range) == 2:
            start_year, end_year = year_range
            try:
                # Dateåˆ—ãŒdatetimeå‹ã§ãªã„å ´åˆã¯å¤‰æ›ã‚’è©¦è¡Œ
                if not pd.api.types.is_datetime64_any_dtype(df['Date']):
                    df['Date'] = pd.to_datetime(df['Date'])
                
                mask = (df['Date'].dt.year >= start_year) & (df['Date'].dt.year <= end_year)
                df_filtered = df[mask]
                
                if len(df_filtered) > 0:
                    df = df_filtered
            except Exception as e:
                pass  # ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã¯ãã®ã¾ã¾é€²ã‚€
        
        if len(df) > 0:
            data_summary.append(f"- {filename}: æœŸé–“{df['Date'].min().strftime('%Yå¹´%mæœˆ')}ï½{df['Date'].max().strftime('%Yå¹´%mæœˆ')}, æœ€æ–°å€¤{df['Value'].iloc[-1]:.2f}")
    
    summary_text = "\n".join(data_summary)
    
    # å˜ä¸€ã‚°ãƒ©ãƒ•ã¨åŒã˜ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå½¢å¼ã‚’ä½¿ç”¨
    composite_prompt = (
        f"è¤‡åˆãƒ‡ãƒ¼ã‚¿åˆ†æ: {len(analysis_results)}å€‹ã®çµŒæ¸ˆæŒ‡æ¨™\n\n"
        "ä»¥ä¸‹ã¯æ™‚ç³»åˆ—ã®çµŒæ¸ˆãƒ‡ãƒ¼ã‚¿ã§ã™ã€‚\n"
        "ã‚°ãƒ©ãƒ•ã‚’åˆ†æã—ã€ä»¥ä¸‹ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼š\n"
        "1. ãƒˆãƒ¬ãƒ³ãƒ‰ã®è¦ç‚¹ã‚’æ•´ç†ã—ã€ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ãä»Šå¾Œã®çµŒæ¸ˆå½±éŸ¿ã‚’äºˆæ¸¬ã—ã¦ãã ã•ã„ã€‚80æ–‡å­—ä»¥ä¸Š100æ–‡å­—ä»¥å†…ã§æ–­è¨€èª¿ï¼ˆã€œã ã€ã€œã§ã‚ã‚‹ï¼‰ã§è¨˜è¿°ã—ã€æ–‡å­—æ•°ã¯è¡¨ç¤ºã—ãªã„ã§ãã ã•ã„ã€‚\n\n"
        f"ãƒ‡ãƒ¼ã‚¿çµ±è¨ˆ:\n"
        f"{summary_text}\n\n"
        "ã€è¤‡åˆåˆ†æãƒ‡ãƒ¼ã‚¿ã€‘:\n"
        f"åˆ†æå¯¾è±¡: {len(analysis_results)}å€‹ã®çµŒæ¸ˆæŒ‡æ¨™ã®æ¨ªæ–­çš„åˆ†æ"
    )
    
    composite_title_prompt = (
        f"è¤‡åˆãƒ‡ãƒ¼ã‚¿åˆ†æ: {len(analysis_results)}å€‹ã®çµŒæ¸ˆæŒ‡æ¨™\n\n"
        "ä»¥ä¸‹ã¯æ™‚ç³»åˆ—ã®çµŒæ¸ˆãƒ‡ãƒ¼ã‚¿ã§ã™ã€‚\n"
        "ã“ã®ãƒ‡ãƒ¼ã‚¿ã®åˆ†æçµæœã‚’è¡¨ç¾ã™ã‚‹ã€15æ–‡å­—ç¨‹åº¦ã®ç°¡æ½”ãªã‚¿ã‚¤ãƒˆãƒ«ã‚’1ã¤ã ã‘ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚\n"
        "ã‚¿ã‚¤ãƒˆãƒ«ã®ã¿ã‚’å›ç­”ã—ã€èª¬æ˜æ–‡ã¯ä¸è¦ã§ã™ã€‚\n\n"
        f"ã€åˆ†æå¯¾è±¡ã€‘:\n{summary_text}"
    )
    
    try:
        response = model.generate_content(composite_prompt)
        composite_insight = response.text.strip()
        
        # å˜ä¸€ã‚°ãƒ©ãƒ•ã¨åŒã˜æ–‡å­—æ•°åˆ¶é™ï¼ˆ80-100æ–‡å­—ï¼‰
        insight_length = len(composite_insight)
        if insight_length < 80:
            # 80æ–‡å­—æœªæº€ã®å ´åˆã¯å†ç”Ÿæˆã‚’è©¦è¡Œ
            extended_prompt = composite_prompt.replace(
                "1. ãƒˆãƒ¬ãƒ³ãƒ‰ã®è¦ç‚¹ã‚’æ•´ç†ã—ã€ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ãä»Šå¾Œã®çµŒæ¸ˆå½±éŸ¿ã‚’äºˆæ¸¬ã—ã¦ãã ã•ã„ã€‚80æ–‡å­—ä»¥ä¸Š100æ–‡å­—ä»¥å†…ã§æ–­è¨€èª¿ï¼ˆã€œã ã€ã€œã§ã‚ã‚‹ï¼‰ã§è¨˜è¿°ã—ã€æ–‡å­—æ•°ã¯è¡¨ç¤ºã—ãªã„ã§ãã ã•ã„ã€‚\n",
                "1. ãƒˆãƒ¬ãƒ³ãƒ‰ã®è¦ç‚¹ã‚’æ•´ç†ã—ã€ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ãä»Šå¾Œã®çµŒæ¸ˆå½±éŸ¿ã‚’äºˆæ¸¬ã—ã¦ãã ã•ã„ã€‚80æ–‡å­—ä»¥ä¸Š100æ–‡å­—ä»¥å†…ã§æ–­è¨€èª¿ï¼ˆã€œã ã€ã€œã§ã‚ã‚‹ï¼‰ã§è©³ç´°ã«è¨˜è¿°ã—ã€å…·ä½“çš„ãªå‚¾å‘ã‚’å«ã‚ã¦æ–‡å­—æ•°ã¯è¡¨ç¤ºã—ãªã„ã§ãã ã•ã„ã€‚\n"
            )
            response = model.generate_content(extended_prompt)
            composite_insight = response.text.strip()
            insight_length = len(composite_insight)
        
        if insight_length > 100:
            # 100æ–‡å­—è¶…éã®å ´åˆã¯åˆ‡ã‚Šè©°ã‚ã‚‹
            composite_insight = composite_insight[:100]
        
        title_response = model.generate_content(composite_title_prompt)
        composite_title = title_response.text.strip()
        
        return composite_insight, composite_title
    except Exception as e:
        # ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ–‡å­—æ•°èª¿æ•´
        default_insight = f"è¤‡æ•°çµŒæ¸ˆæŒ‡æ¨™ã®æ¨ªæ–­åˆ†æã«ã‚ˆã‚Šã€æ—¥æœ¬çµŒæ¸ˆã®æ§‹é€ çš„å¤‰åŒ–ã¨ä»Šå¾Œã®æ”¿ç­–æ–¹å‘æ€§ã‚’ç·åˆçš„ã«è©•ä¾¡ã—ãŸçµæœã€æŒç¶šçš„æˆé•·ã¸ã®èª²é¡ŒãŒæ˜ç¢ºã«ãªã£ãŸã€‚"
        return default_insight, "çµŒæ¸ˆæŒ‡æ¨™è¤‡åˆåˆ†æ"

# ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ
st.subheader("â‘  CSVãƒ•ã‚¡ã‚¤ãƒ«ã®é¸æŠ")

categorized_files, categorized_paths, all_filenames = get_categorized_csv_files(CSV_FOLDER, CSV_CATEGORIES)

if not categorized_files:
    st.error(f"æŒ‡å®šãƒ•ã‚©ãƒ«ãƒ€ã€Œ{CSV_FOLDER}ã€ã«å¯¾è±¡ã®CSVãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚")
    st.stop()

selected_files = []
selected_paths = []

st.write("**â–  åˆ†æå¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼ˆè¤‡æ•°é¸æŠå¯èƒ½ï¼‰:**")

for category, filenames in categorized_files.items():
    st.write(f"**{category}**")
    
    select_all = st.checkbox(f"â–  {category}ã®å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ", key=f"select_all_{category}")
    
    col1, col2 = st.columns([1, 3])
    with col2:
        for filename in filenames:
            default_checked = select_all
            
            if st.checkbox(filename, value=default_checked, key=f"file_{category}_{filename}"):
                selected_files.append(filename)
                file_index = categorized_files[category].index(filename)
                selected_paths.append(categorized_paths[category][file_index])
    
    st.write("")

if selected_files:
    st.success(f"âœ“ é¸æŠã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«æ•°: **{len(selected_files)}å€‹**")
    with st.expander("é¸æŠã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§"):
        for i, filename in enumerate(selected_files, 1):
            st.write(f"{i}. {filename}")
else:
    st.warning("âš ï¸ åˆ†æã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚")
    st.stop()

# ã‚°ãƒ©ãƒ•ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºè¨­å®š
st.subheader("â‘¡ ã‚°ãƒ©ãƒ•ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºè¨­å®š")
col1, col2, col3 = st.columns(3)

with col1:
    enable_year_filter = st.checkbox("â–  å¹´åº¦ç¯„å›²ã‚’æŒ‡å®š", value=False)
    
with col2:
    if enable_year_filter:
        # ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å¹´åº¦ç¯„å›²ã‚’å–å¾—ã—ã¦åˆæœŸå€¤ã‚’è¨­å®š
        all_years = set()
        for file_path in selected_paths:
            try:
                temp_df, _ = load_csv_data(file_path)
                if temp_df is not None and 'Date' in temp_df.columns:
                    # Dateåˆ—ãŒdatetimeå‹ã§ãªã„å ´åˆã¯å¤‰æ›ã‚’è©¦è¡Œ
                    if not pd.api.types.is_datetime64_any_dtype(temp_df['Date']):
                        temp_df['Date'] = pd.to_datetime(temp_df['Date'], errors='coerce')
                    
                    # NaTã§ãªã„å€¤ã‹ã‚‰å¹´ã‚’å–å¾—
                    valid_dates = temp_df['Date'].dropna()
                    if len(valid_dates) > 0:
                        all_years.update(valid_dates.dt.year.unique())
            except Exception as e:
                continue
        
        if all_years:
            # 2024å¹´ã¾ã§ã«åˆ¶é™
            all_years = {year for year in all_years if year <= 2024}
            
            if all_years:
                min_year = min(all_years)
                max_year = max(all_years)
                start_year = st.selectbox("é–‹å§‹å¹´", options=sorted(all_years), index=0)
                end_year = st.selectbox("çµ‚äº†å¹´", options=sorted(all_years), index=len(sorted(all_years))-1)
                year_range = [start_year, end_year]
            else:
                st.warning("2024å¹´ä»¥å‰ã®ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ")
                year_range = None
        else:
            st.warning("å¹´åº¦ãƒ‡ãƒ¼ã‚¿ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ")
            year_range = None
    else:
        year_range = None

with col3:
    enable_highlight = st.checkbox("â— ç›´å‰æ¯”å¤‰åŒ–ç‚¹ã‚’å¼·èª¿è¡¨ç¤º", value=True)

# Gemini APIã‚­ãƒ¼ã®å–å¾—
api_key = os.getenv("GOOGLE_API_KEY")
if not api_key:
    st.error("ç’°å¢ƒå¤‰æ•° 'GOOGLE_API_KEY' ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚PowerShell ã¾ãŸã¯ .env ã§è¨­å®šã—ã¦ãã ã•ã„ã€‚")
    st.stop()

genai.configure(api_key=api_key)
model = genai.GenerativeModel("gemini-2.5-flash-preview-04-17")

# ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã¨åˆ†æ
st.subheader("â‘¢ ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã¨åˆ†æ")

analysis_results = []

for i, (filename, file_path) in enumerate(zip(selected_files, selected_paths)):
    st.write(f"**â— {i+1}/{len(selected_files)}: {filename}**")
    
    df, error_message = load_csv_data(file_path)
    
    if error_message and "æ³¨æ„:" not in error_message:
        st.error(f"âŒ {filename}: {error_message}")
        continue
    elif error_message:
        st.warning(f"âš ï¸ {filename}: {error_message}")
    
    if df is None or len(df) == 0:
        st.error(f"âŒ {filename}: æœ‰åŠ¹ãªãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚")
        continue
    
    # ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã•ã‚ŒãŸã‚°ãƒ©ãƒ•ã‚’ä½œæˆ
    result = create_graph(df, filename, year_range, enable_highlight, model if enable_highlight else None)
    
    # create_graphé–¢æ•°ãŒã‚¨ãƒ©ãƒ¼ã§Noneã‚’è¿”ã—ãŸå ´åˆã®å‡¦ç†
    if result is None or result[0] is None:
        st.error(f"âŒ {filename}: ã‚°ãƒ©ãƒ•ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ‡ãƒ¼ã‚¿å½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚")
        continue
    
    fig, graph_title = result
    
    with st.spinner(f"AIåˆ†æä¸­... ({filename})"):
        insight, slide_title = generate_ai_insights(df, filename, model)
    
    analysis_results.append({
        'filename': filename,
        'df': df,
        'fig': fig,
        'graph_title': graph_title,
        'insight': insight,
        'slide_title': slide_title
    })
    
    col1, col2 = st.columns([2, 1])
    with col1:
        st.pyplot(fig)
    with col2:
        # å¹´åº¦ãƒ•ã‚£ãƒ«ã‚¿é©ç”¨å¾Œã®ãƒ‡ãƒ¼ã‚¿çµ±è¨ˆ
        display_df = df.copy()
        if year_range:
            # Dateåˆ—ãŒdatetimeå‹ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
            if not pd.api.types.is_datetime64_any_dtype(display_df['Date']):
                try:
                    display_df['Date'] = pd.to_datetime(display_df['Date'])
                except:
                    pass  # å¤‰æ›ã§ããªã„å ´åˆã¯ãã®ã¾ã¾é€²ã‚€
            
            # datetimeå‹ã®å ´åˆã®ã¿ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚’å®Ÿè¡Œ
            if pd.api.types.is_datetime64_any_dtype(display_df['Date']):
                try:
                    mask = (display_df['Date'].dt.year >= year_range[0]) & (display_df['Date'].dt.year <= year_range[1])
                    filtered_df = display_df[mask]
                    if len(filtered_df) > 0:
                        display_df = filtered_df
                except:
                    pass  # ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã¯ãã®ã¾ã¾é€²ã‚€
        
        st.write(f"**ãƒ‡ãƒ¼ã‚¿ä»¶æ•°:** {len(display_df)}è¡Œ")
        if not display_df['Date'].isna().all():
            date_min = display_df['Date'].min()
            date_max = display_df['Date'].max()
            if pd.notna(date_min) and pd.notna(date_max):
                st.write(f"**æœŸé–“:** {date_min.strftime('%Yå¹´%mæœˆ')} ï½ {date_max.strftime('%Yå¹´%mæœˆ')}")
        st.write(f"**æœ€å¤§å€¤:** {display_df['Value'].max():.2f}")
        st.write(f"**æœ€å°å€¤:** {display_df['Value'].min():.2f}")
        st.write(f"**å¹³å‡å€¤:** {display_df['Value'].mean():.2f}")
        
        # ç›´å‰æ¯”å¤‰åŒ–ç‚¹æƒ…å ±ã®è¡¨ç¤º
        if enable_highlight:
            changes = detect_sequential_significant_changes(display_df)
            if changes:
                st.write("**â— ç›´å‰æ¯”ä¸»è¦å¤‰åŒ–ç‚¹:**")
                for j, change in enumerate(changes, 1):
                    direction = "ä¸Šæ˜‡" if change['change_rate'] > 0 else "ä¸‹è½"
                    st.write(f"{j}. {change['date'].strftime('%Yå¹´%mæœˆ')}: ç›´å‰æ¯”{change['change_rate']:+.1f}%{direction}")
    
    st.write(f"**[AI] AIã‚¿ã‚¤ãƒˆãƒ«:** {slide_title}")
    st.write(f"**[AI] åˆ†æçµæœ:** {insight}")
    st.write("---")

# PowerPointç”Ÿæˆ
st.subheader("â‘£ PowerPointç”Ÿæˆ")

if analysis_results:
    st.success(f"âœ“ åˆ†æå®Œäº†: {len(analysis_results)}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‡¦ç†ã—ã¾ã—ãŸ")
    
    if categorized_files:
        st.write("**â–  ã‚«ãƒ†ã‚´ãƒªåˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§:**")
        for category, filenames in categorized_files.items():
            selected_in_category = [f for f in filenames if f in selected_files]
            st.write(f"**{category}** ({len(filenames)}å€‹, é¸æŠ: {len(selected_in_category)}å€‹)")
            for i, filename in enumerate(filenames, 1):
                if filename in selected_files:
                    st.write(f"   âœ“ {i}. **{filename}** (é¸æŠä¸­)")
                else:
                    st.write(f"   {i}. {filename}")
            st.write("")
    
    if st.button("â–  PowerPointã‚’ç”Ÿæˆ", type="primary"):
        with st.spinner("PowerPointã‚’ç”Ÿæˆä¸­..."):
            try:
                if not os.path.exists(PPTX_TEMPLATE_PATH):
                    st.error(f"ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: {PPTX_TEMPLATE_PATH}")
                else:
                    prs = Presentation(PPTX_TEMPLATE_PATH)
                    
                    original_slides = len(prs.slides)
                    st.info(f"æ—¢å­˜ã‚¹ãƒ©ã‚¤ãƒ‰æ•°: {original_slides}æš")
                    
                    if original_slides < 2:
                        st.error("ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«æœ€ä½2æšã®ã‚¹ãƒ©ã‚¤ãƒ‰ãŒå¿…è¦ã§ã™ã€‚")
                    else:
                        st.info("ğŸ“„ 1æšç›®: ã‚¿ã‚¤ãƒˆãƒ«ãƒšãƒ¼ã‚¸ã‚’ç·¨é›†ä¸­...")
                        
                        title_slide = prs.slides[0]
                        text_boxes = []
                        for shape in title_slide.shapes:
                            if hasattr(shape, 'text_frame') and shape.text_frame:
                                text_boxes.append(shape)
                        
                        if len(text_boxes) >= 1:
                            title_box = text_boxes[0]
                            title_box.text_frame.clear()
                            title_para = title_box.text_frame.add_paragraph()
                            title_para.text = "çµŒæ¸ˆãƒ‡ãƒ¼ã‚¿åˆ†æãƒ¬ãƒãƒ¼ãƒˆï¼ˆç›´å‰æ¯”é‡ç‚¹åˆ†æï¼‰"
                            title_para.font.size = Pt(28)
                            title_para.font.bold = True
                            title_para.alignment = PP_ALIGN.LEFT
                        
                        if len(text_boxes) >= 2:
                            info_box = text_boxes[1]
                            info_box.text_frame.clear()
                            para1 = info_box.text_frame.add_paragraph()
                            para1.text = f"ä½œæˆæ—¥: {datetime.now().strftime('%Yå¹´%mæœˆ%dæ—¥')}"
                            para1.font.size = Pt(16)
                            para1.alignment = PP_ALIGN.LEFT
                        
                        base_slide = prs.slides[1]
                        slide_layout = base_slide.slide_layout
                        
                        for i, result in enumerate(analysis_results):
                            st.info(f"ğŸ“ˆ {i+2}æšç›®: {result['filename']} ã®ãƒšãƒ¼ã‚¸ã‚’ä½œæˆä¸­...")
                            
                            if i == 0:
                                content_slide = base_slide
                            else:
                                insert_index = 1 + i
                                
                                xml_slides = prs.slides._sldIdLst
                                slide_layout = base_slide.slide_layout
                                content_slide = prs.slides.add_slide(slide_layout)
                                
                                new_slide_element = xml_slides[-1]
                                xml_slides.remove(new_slide_element)
                                xml_slides.insert(insert_index, new_slide_element)
                            
                            content_text_boxes = []
                            for shape in content_slide.shapes:
                                if hasattr(shape, 'text_frame') and shape.text_frame:
                                    content_text_boxes.append(shape)
                            
                            # ãƒªãƒ¼ãƒ‰æ–‡ã®é…ç½®ï¼ˆä¸Šéƒ¨ã€å·¦å¯„ã›ï¼‰
                            if len(content_text_boxes) >= 1:
                                insight_box = content_text_boxes[0]
                                insight_box.text_frame.clear()
                                insight_box.text_frame.text = result['insight']
                                for paragraph in insight_box.text_frame.paragraphs:
                                    paragraph.font.size = Pt(16)
                                    paragraph.font.bold = False
                                    paragraph.alignment = PP_ALIGN.LEFT
                            
                            # ã‚¿ã‚¤ãƒˆãƒ«ã®é…ç½®ï¼ˆå·¦ä¸Šã€å¤§ãã‚ã€å¤ªå­—ï¼‰
                            if len(content_text_boxes) >= 2:
                                page_title_box = content_text_boxes[1]
                                page_title_box.text_frame.clear()
                                page_title_box.text_frame.text = result['slide_title']
                                for paragraph in page_title_box.text_frame.paragraphs:
                                    paragraph.font.size = Pt(32)
                                    paragraph.font.bold = True
                                    paragraph.alignment = PP_ALIGN.LEFT
                            
                            # ç·¨é›†å¯èƒ½ãªã‚°ãƒ©ãƒ•ã‚’ä½œæˆï¼ˆç›´å‰æ¯”å¯¾å¿œï¼‰
                            editable_fig, editable_title, change_reasons = create_editable_graph(
                                result['df'], result['filename'], year_range, enable_highlight, model if enable_highlight else None
                            )
                            
                            if editable_fig is not None:
                                # ã‚°ãƒ©ãƒ•ã‚’æŒ¿å…¥
                                graph_path = f"temp_editable_graph_{i}_{result['filename'].replace('.csv', '').replace(' ', '_')}.png"
                                try:
                                    editable_fig.savefig(graph_path, dpi=200, bbox_inches='tight', 
                                                        facecolor='white', edgecolor='none', 
                                                        pad_inches=0.1)
                                    
                                    # ã‚°ãƒ©ãƒ•ã‚’ä¸­å¤®ã«å¤§ããé…ç½®
                                    content_slide.shapes.add_picture(
                                        graph_path, 
                                        Cm(7),      # å·¦ã‹ã‚‰7cm
                                        Cm(6),      # ä¸Šã‹ã‚‰6cm
                                        width=Cm(20),   # å¹…20cm
                                        height=Cm(12)   # é«˜ã•12cm
                                    )
                                    
                                    # ã‚°ãƒ©ãƒ•ã‚¿ã‚¤ãƒˆãƒ«ã‚’ãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹ã§è¿½åŠ 
                                    title_textbox = content_slide.shapes.add_textbox(
                                        Cm(7), Cm(5.2), Cm(20), Cm(0.6)
                                    )
                                    title_frame = title_textbox.text_frame
                                    title_frame.clear()
                                    title_frame.text = editable_title
                                    for paragraph in title_frame.paragraphs:
                                        paragraph.font.size = Pt(12)
                                        paragraph.font.bold = False
                                        paragraph.alignment = PP_ALIGN.CENTER
                                    
                                    # Yè»¸ãƒ©ãƒ™ãƒ«ã‚’ãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹ã§è¿½åŠ 
                                    y_label_textbox = content_slide.shapes.add_textbox(
                                        Cm(6), Cm(9), Cm(0.8), Cm(6)
                                    )
                                    y_label_frame = y_label_textbox.text_frame
                                    y_label_frame.clear()
                                    y_label_frame.text = "æ•°å€¤"
                                    for paragraph in y_label_frame.paragraphs:
                                        paragraph.font.size = Pt(10)
                                        paragraph.alignment = PP_ALIGN.CENTER
                                    
                                    # Xè»¸ãƒ©ãƒ™ãƒ«ã‚’ãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹ã§è¿½åŠ 
                                    x_label_textbox = content_slide.shapes.add_textbox(
                                        Cm(15), Cm(18.5), Cm(4), Cm(0.6)
                                    )
                                    x_label_frame = x_label_textbox.text_frame
                                    x_label_frame.clear()
                                    x_label_frame.text = "å¹´æœˆ"
                                    for paragraph in x_label_frame.paragraphs:
                                        paragraph.font.size = Pt(10)
                                        paragraph.alignment = PP_ALIGN.CENTER
                                    
                                    # ç›´å‰æ¯”å¤‰åŒ–ç‚¹ã®èª¬æ˜ã‚’é•·æ–¹å½¢å›³å½¢ã§è¿½åŠ 
                                    if change_reasons:
                                        # ã‚°ãƒ©ãƒ•å¢ƒç•Œã®å®šç¾©
                                        graph_bounds = {
                                            'left': 7,      # ã‚°ãƒ©ãƒ•ã®å·¦ç«¯ä½ç½®(cm)
                                            'top': 6,       # ã‚°ãƒ©ãƒ•ã®ä¸Šç«¯ä½ç½®(cm)
                                            'right': 27,    # ã‚°ãƒ©ãƒ•ã®å³ç«¯ä½ç½®(cm) = 7 + 20
                                            'bottom': 18    # ã‚°ãƒ©ãƒ•ã®ä¸‹ç«¯ä½ç½®(cm) = 6 + 12
                                        }
                                        
                                        # ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å¾Œã®ãƒ‡ãƒ¼ã‚¿ã§ã‚°ãƒ©ãƒ•ã®åº§æ¨™ç³»ã‚’è¨ˆç®—
                                        df_plot = result['df'].copy()
                                        if year_range:
                                            try:
                                                if not pd.api.types.is_datetime64_any_dtype(df_plot['Date']):
                                                    df_plot['Date'] = pd.to_datetime(df_plot['Date'])
                                                mask = (df_plot['Date'].dt.year >= year_range[0]) & (df_plot['Date'].dt.year <= year_range[1])
                                                df_filtered = df_plot[mask]
                                                if len(df_filtered) > 0:
                                                    df_plot = df_filtered
                                            except:
                                                pass
                                        
                                        df_plot = df_plot.sort_values('Date')
                                        
                                        if len(df_plot) > 0:
                                            date_min = df_plot['Date'].min()
                                            date_max = df_plot['Date'].max()
                                            value_min = df_plot['Value'].min()
                                            value_max = df_plot['Value'].max()
                                            
                                            # ä½¿ç”¨æ¸ˆã¿é•·æ–¹å½¢ä½ç½®ã‚’è¿½è·¡
                                            used_positions = []
                                            
                                            for j, change_info in enumerate(change_reasons):
                                                if j < 4:  # æœ€å¤§4ã¤ã¾ã§
                                                    # å¤‰åŒ–ç‚¹ã®åº§æ¨™ã‚’è¨ˆç®—
                                                    try:
                                                        # æ—¥ä»˜ã®ç›¸å¯¾ä½ç½®ï¼ˆ0-1ã®ç¯„å›²ï¼‰
                                                        if date_max != date_min:
                                                            date_ratio = (change_info['date'] - date_min).total_seconds() / (date_max - date_min).total_seconds()
                                                        else:
                                                            date_ratio = 0.5
                                                        
                                                        # å€¤ã®ç›¸å¯¾ä½ç½®ï¼ˆ0-1ã®ç¯„å›²ï¼‰
                                                        if value_max != value_min:
                                                            value_ratio = (change_info['value'] - value_min) / (value_max - value_min)
                                                        else:
                                                            value_ratio = 0.5
                                                        
                                                        # ã‚°ãƒ©ãƒ•ä¸Šã®å®Ÿéš›ã®åº§æ¨™ï¼ˆcmï¼‰
                                                        point_x = graph_bounds['left'] + (date_ratio * (graph_bounds['right'] - graph_bounds['left']))
                                                        point_y = graph_bounds['top'] + (graph_bounds['bottom'] - graph_bounds['top']) - (value_ratio * (graph_bounds['bottom'] - graph_bounds['top']))  # Yè»¸ã¯ä¸Šä¸‹åè»¢
                                                        
                                                        # æœ€é©é…ç½®ä½ç½®ã‚’è¨ˆç®—
                                                        optimal_x, optimal_y = calculate_optimal_callout_position(
                                                            point_x, point_y, used_positions, graph_bounds
                                                        )
                                                        
                                                        # ä½¿ç”¨æ¸ˆã¿ä½ç½®ã«è¿½åŠ 
                                                        used_positions.append({'x': optimal_x, 'y': optimal_y})
                                                        
                                                        # ç›´å‰æ¯”æƒ…å ±ã‚’å«ã‚€ã‚³ãƒ¡ãƒ³ãƒˆãƒ†ã‚­ã‚¹ãƒˆ
                                                        change_comment = f"{change_info['reason']}\n(ç›´å‰æ¯”{change_info['change_rate']:+.1f}%)"
                                                        
                                                        # é•·æ–¹å½¢ã‚³ãƒ¡ãƒ³ãƒˆãƒœãƒƒã‚¯ã‚¹ã¨æ¥ç¶šç·šã‚’è¿½åŠ 
                                                        add_callout_with_connector(
                                                            content_slide,
                                                            point_x, point_y,  # æ³¨ç›®ãƒã‚¤ãƒ³ãƒˆã®åº§æ¨™
                                                            optimal_x, optimal_y,  # é•·æ–¹å½¢ã®åº§æ¨™
                                                            change_comment  # ç›´å‰æ¯”æƒ…å ±ä»˜ãã‚³ãƒ¡ãƒ³ãƒˆ
                                                        )
                                                        
                                                    except Exception as coord_error:
                                                        # åº§æ¨™è¨ˆç®—ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã¯æ¨å®šä½ç½®ã«é…ç½®
                                                        estimated_point_x = 15 + (j * 3)
                                                        estimated_point_y = 12 + (j * 1)
                                                        
                                                        near_x = estimated_point_x + 1.5
                                                        near_y = estimated_point_y - 1.0
                                                        
                                                        used_positions.append({'x': near_x, 'y': near_y})
                                                        
                                                        yoy_comment = f"{change_info['reason']}\n(ç›´å‰æ¯”{change_info['change_rate']:+.1f}%)"
                                                        
                                                        add_callout_with_connector(
                                                            content_slide,
                                                            estimated_point_x, estimated_point_y,
                                                            near_x, near_y,
                                                            yoy_comment
                                                        )
                                    
                                    # å‡ºå…¸ã‚’ãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹ã§è¿½åŠ 
                                    source_textbox = content_slide.shapes.add_textbox(
                                        Cm(20), Cm(20.5), Cm(6), Cm(0.8)
                                    )
                                    source_frame = source_textbox.text_frame
                                    source_frame.clear()
                                    source_frame.text = f"å‡ºå…¸ï¼š{result['filename']}"
                                    for paragraph in source_frame.paragraphs:
                                        paragraph.font.size = Pt(9)
                                        paragraph.alignment = PP_ALIGN.RIGHT
                                    
                                    if os.path.exists(graph_path):
                                        os.remove(graph_path)
                                    
                                except Exception as graph_error:
                                    st.error(f"ã‚°ãƒ©ãƒ•æŒ¿å…¥ã‚¨ãƒ©ãƒ¼ ({result['filename']}): {graph_error}")
                            else:
                                st.error(f"ç·¨é›†å¯èƒ½ã‚°ãƒ©ãƒ•ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ: {result['filename']}")
                        
                        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
                        
                        if len(analysis_results) > 1:
                            st.info("ğŸ“Š è¤‡åˆã‚°ãƒ©ãƒ•ãƒšãƒ¼ã‚¸: å…¨ãƒ‡ãƒ¼ã‚¿ã®è¤‡åˆåˆ†æã‚’ä½œæˆä¸­...")
                            
                            composite_fig = create_composite_graph(analysis_results, year_range)
                            
                            with st.spinner("è¤‡åˆåˆ†æã®AIç¤ºå”†ã‚’ç”Ÿæˆä¸­..."):
                                composite_insight, composite_title = generate_composite_insights(analysis_results, model, year_range)
                            
                            slide_layout = base_slide.slide_layout
                            composite_slide = prs.slides.add_slide(slide_layout)
                            
                            xml_slides = prs.slides._sldIdLst
                            new_slide_element = xml_slides[-1]
                            xml_slides.remove(new_slide_element)
                            insert_position = 1 + len(analysis_results)
                            xml_slides.insert(insert_position, new_slide_element)
                            
                            composite_text_boxes = []
                            for shape in composite_slide.shapes:
                                if hasattr(shape, 'text_frame') and shape.text_frame:
                                    composite_text_boxes.append(shape)
                            
                            # è¤‡åˆåˆ†æã®ãƒªãƒ¼ãƒ‰æ–‡ã®é…ç½®
                            if len(composite_text_boxes) >= 1:
                                insight_box = composite_text_boxes[0]
                                insight_box.text_frame.clear()
                                insight_box.text_frame.text = composite_insight
                                for paragraph in insight_box.text_frame.paragraphs:
                                    paragraph.font.size = Pt(16)
                                    paragraph.font.bold = False
                                    paragraph.alignment = PP_ALIGN.LEFT
                            
                            # è¤‡åˆåˆ†æã®ã‚¿ã‚¤ãƒˆãƒ«ã®é…ç½®
                            if len(composite_text_boxes) >= 2:
                                page_title_box = composite_text_boxes[1]
                                page_title_box.text_frame.clear()
                                page_title_box.text_frame.text = composite_title
                                for paragraph in page_title_box.text_frame.paragraphs:
                                    paragraph.font.size = Pt(32)
                                    paragraph.font.bold = True
                                    paragraph.alignment = PP_ALIGN.LEFT
                            
                            composite_graph_path = f"temp_composite_graph_{timestamp}.png"
                            try:
                                composite_fig.savefig(composite_graph_path, dpi=200, bbox_inches='tight', 
                                                    facecolor='white', edgecolor='none', 
                                                    pad_inches=0.1)
                                
                                # è¤‡åˆã‚°ãƒ©ãƒ•ã‚’ä¸­å¤®ã«å¤§ããé…ç½®
                                composite_slide.shapes.add_picture(
                                    composite_graph_path, 
                                    Cm(7),
                                    Cm(6),
                                    width=Cm(20),
                                    height=Cm(12)
                                )
                                
                                # è¤‡åˆã‚°ãƒ©ãƒ•ã®ã‚¿ã‚¤ãƒˆãƒ«ã‚’ãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹ã§è¿½åŠ 
                                comp_title_textbox = composite_slide.shapes.add_textbox(
                                    Cm(7), Cm(5.2), Cm(20), Cm(0.6)
                                )
                                comp_title_frame = comp_title_textbox.text_frame
                                comp_title_frame.clear()
                                comp_title_frame.text = f"{len(analysis_results)}æŒ‡æ¨™è¤‡åˆåˆ†æ - çµŒæ¸ˆå‹•å‘ç·åˆè©•ä¾¡"
                                for paragraph in comp_title_frame.paragraphs:
                                    paragraph.font.size = Pt(12)
                                    paragraph.font.bold = False
                                    paragraph.alignment = PP_ALIGN.CENTER
                                
                                # è¤‡åˆã‚°ãƒ©ãƒ•ã®è»¸ãƒ©ãƒ™ãƒ«
                                comp_y_label_textbox = composite_slide.shapes.add_textbox(
                                    Cm(6), Cm(9), Cm(0.8), Cm(6)
                                )
                                comp_y_label_frame = comp_y_label_textbox.text_frame
                                comp_y_label_frame.clear()
                                comp_y_label_frame.text = "æ•°å€¤"
                                for paragraph in comp_y_label_frame.paragraphs:
                                    paragraph.font.size = Pt(10)
                                    paragraph.alignment = PP_ALIGN.CENTER
                                
                                comp_x_label_textbox = composite_slide.shapes.add_textbox(
                                    Cm(15), Cm(18.5), Cm(4), Cm(0.6)
                                )
                                comp_x_label_frame = comp_x_label_textbox.text_frame
                                comp_x_label_frame.clear()
                                comp_x_label_frame.text = "å¹´æœˆ"
                                for paragraph in comp_x_label_frame.paragraphs:
                                    paragraph.font.size = Pt(10)
                                    paragraph.alignment = PP_ALIGN.CENTER
                                
                                # è¤‡åˆã‚°ãƒ©ãƒ•ã®å‡ºå…¸ã‚’ãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹ã§è¿½åŠ 
                                comp_source_textbox = composite_slide.shapes.add_textbox(
                                    Cm(20), Cm(20.5), Cm(6), Cm(0.8)
                                )
                                comp_source_frame = comp_source_textbox.text_frame
                                comp_source_frame.clear()
                                source_files = ", ".join([result['filename'] for result in analysis_results[:3]])
                                if len(analysis_results) > 3:
                                    source_files += f" ä»–{len(analysis_results)-3}ä»¶"
                                comp_source_frame.text = f"å‡ºå…¸ï¼š{source_files}"
                                for paragraph in comp_source_frame.paragraphs:
                                    paragraph.font.size = Pt(9)
                                    paragraph.alignment = PP_ALIGN.RIGHT
                                
                                if os.path.exists(composite_graph_path):
                                    os.remove(composite_graph_path)
                                
                                st.success("âœ“ è¤‡åˆã‚°ãƒ©ãƒ•ãƒšãƒ¼ã‚¸ã‚’è¿½åŠ å®Œäº†")
                                
                            except Exception as graph_error:
                                st.error(f"è¤‡åˆã‚°ãƒ©ãƒ•æŒ¿å…¥ã‚¨ãƒ©ãƒ¼: {graph_error}")
                        
                        else:
                            st.info("â„¹ï¸ ãƒ‡ãƒ¼ã‚¿ãŒ1ã¤ã®ãŸã‚ã€è¤‡åˆã‚°ãƒ©ãƒ•ã¯ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã—ãŸ")
                        
                        pptx_filename = f"çµŒæ¸ˆåˆ†æãƒ¬ãƒãƒ¼ãƒˆ_ç›´å‰æ¯”é‡ç‚¹_{timestamp}.pptx"
                        
                        prs.save(pptx_filename)
                        
                        with open(pptx_filename, "rb") as f:
                            st.download_button(
                                label="â–  PowerPointã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰",
                                data=f,
                                file_name=pptx_filename,
                                mime="application/vnd.openxmlformats-officedocument.presentationml.presentation",
                                type="primary"
                            )
                        
                        total_slides = len(prs.slides)
                        st.success(f"âœ“ PowerPointãƒ•ã‚¡ã‚¤ãƒ«ã€Œ{pptx_filename}ã€ãŒæ­£å¸¸ã«ç”Ÿæˆã•ã‚Œã¾ã—ãŸï¼")
                        st.info("â–  æ§‹æˆ:")
                        st.info(f"   - 1æšç›®: ã‚¿ã‚¤ãƒˆãƒ«ãƒšãƒ¼ã‚¸")
                        st.info(f"   - 2ï½{1+len(analysis_results)}æšç›®: å„ãƒ‡ãƒ¼ã‚¿ã®åˆ†æçµæœï¼ˆ{len(analysis_results)}å€‹ï¼‰")
                        if len(analysis_results) > 1:
                            st.info(f"   - {2+len(analysis_results)}æšç›®: è¤‡åˆã‚°ãƒ©ãƒ•åˆ†æ")
                        if total_slides > 1 + len(analysis_results) + (1 if len(analysis_results) > 1 else 0):
                            remaining_start = 2 + len(analysis_results) + (1 if len(analysis_results) > 1 else 0)
                            st.info(f"   - {remaining_start}ï½{total_slides}æšç›®: ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®å…ƒãƒšãƒ¼ã‚¸")
                        
                        st.info("ğŸ”¥ NEWæ©Ÿèƒ½: ç›´å‰æ¯”å¤‰åŒ–ç‚¹åˆ†æ")
                        st.info("â–  æ³¨ç›®ãƒã‚¤ãƒ³ãƒˆç®—å‡ºæ–¹æ³•:")
                        st.info("   - ç›´å‰ã®æ•°å€¤ã¨æ¯”è¼ƒã—ã¦æœ€ã‚‚ä¸Šæ˜‡ã—ãŸ2ç‚¹ã‚’æ¤œå‡º")
                        st.info("   - ç›´å‰ã®æ•°å€¤ã¨æ¯”è¼ƒã—ã¦æœ€ã‚‚ä¸‹è½ã—ãŸ2ç‚¹ã‚’æ¤œå‡º")
                        st.info("   - åˆè¨ˆæœ€å¤§4ã¤ã®å¤‰åŒ–ç‚¹ã‚’è‡ªå‹•æŠ½å‡º")
                        st.info("   - ã‚ˆã‚Šæ•æ„Ÿãªå¤‰åŒ–ã‚’æ‰ãˆã‚‹çŸ­æœŸåˆ†æ")
                        st.info("â–  ã‚³ãƒ¡ãƒ³ãƒˆè¡¨ç¤ºå†…å®¹:")
                        st.info("   - å¤‰åŒ–ç†ç”±ï¼ˆ30æ–‡å­—ä»¥å†…ã€æ–­è¨€èª¿ã€Œï½ã ã€ã€Œï½ã§ã‚ã‚‹ã€ã€Œï½ã—ãŸã€ï¼‰")
                        st.info("   - ç›´å‰æ¯”å¤‰åŒ–ç‡ï¼ˆ+XX.X%å½¢å¼ï¼‰")
                        st.info("   - è–„ã„é»„è‰²èƒŒæ™¯ï¼‹èµ¤ã„æ ç·šã®ãƒ‡ã‚¶ã‚¤ãƒ³")                        
                        st.info("â–  é…ç½®ã‚·ã‚¹ãƒ†ãƒ :")
                        st.info("   - æ³¨ç›®ãƒã‚¤ãƒ³ãƒˆã®è¿‘ãã«é•·æ–¹å½¢ã‚’é…ç½®")
                        st.info("   - 24æ–¹å‘Ã—4æ®µéšè·é›¢ã§æœ€é©ä½ç½®ã‚’æ¢ç´¢")
                        st.info("   - ã‚°ãƒ©ãƒ•ã¨ã®é‡è¤‡ã‚’è¨±å¯ï¼ˆå®Ÿç”¨æ€§é‡è¦–ï¼‰")
                        st.info("   - é•·æ–¹å½¢åŒå£«ã®é‡è¤‡ã®ã¿å›é¿ï¼ˆ0.3cmé–“éš”ï¼‰")
                        st.info("â–  AIåˆ†æå¼·åŒ–:")
                        st.info("   - ç›´å‰æ¯”ã®ä¸Šæ˜‡ãƒ»ä¸‹è½æ–¹å‘ã‚’è€ƒæ…®")
                        st.info("   - å…·ä½“çš„ãªçµŒæ¸ˆè¦å› ã‚’åæ˜ ã—ãŸç†ç”±ç”Ÿæˆ")
                        st.info("   - æ­´å²çš„äº‹å®Ÿãƒ»æ”¿ç­–å¤‰æ›´ã‚’è€ƒæ…®ã—ãŸåˆ†æ")
                        
                        if os.path.exists(pptx_filename):
                            file_size = os.path.getsize(pptx_filename)
                            st.info(f"â–  ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: {file_size / 1024:.1f} KB")
                            st.info(f"â–  ã‚°ãƒ©ãƒ•ä½ç½®: å·¦ã‹ã‚‰7cmã€ä¸Šã‹ã‚‰6cmã€ã‚µã‚¤ã‚º: å¹…20cmÃ—é«˜ã•12cm")
                            st.info("â–  ç›´å‰æ¯”å¤‰åŒ–ç‚¹ã¯èµ¤ã„ä¸¸ã§å¼·èª¿è¡¨ç¤º")
                            st.info("â–  é•·æ–¹å½¢ã‚³ãƒ¡ãƒ³ãƒˆã«ã¯ç›´å‰æ¯”%ã‚‚ä½µè¨˜")
            
            except Exception as e:
                st.error(f"Ã— PowerPointç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}")
else:
    st.warning("! åˆ†æçµæœãŒã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦åˆ†æã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚")

# ã‚µã‚¤ãƒ‰ãƒãƒ¼ã«è¿½åŠ æƒ…å ±
with st.sidebar:
    st.header("â–  ã‚¢ãƒ—ãƒªæƒ…å ±")
    st.info(f"**æ¤œç´¢ãƒ•ã‚©ãƒ«ãƒ€:** {CSV_FOLDER}")
    
    total_files = sum(len(files) for files in categorized_files.values())
    st.info(f"**åˆ©ç”¨å¯èƒ½ãƒ•ã‚¡ã‚¤ãƒ«æ•°:** {total_files}å€‹")
    st.info(f"**é¸æŠæ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«æ•°:** {len(selected_files)}å€‹")
    
    st.write("**â–  æ©Ÿèƒ½ä¸€è¦§:**")
    st.write("- CSVãƒ‡ãƒ¼ã‚¿è‡ªå‹•èª­ã¿è¾¼ã¿")
    st.write("- æ—¥æœ¬èªãƒ•ã‚©ãƒ³ãƒˆå¯¾å¿œ")
    st.write("- å¹´åº¦ç¯„å›²ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°")
    st.write("ğŸ”¥ ç›´å‰æ¯”å¤‰åŒ–ç‚¹æ¤œå‡º")
    st.write("- Gemini AIåˆ†æ")
    st.write("- PowerPointè‡ªå‹•ç”Ÿæˆ")
    st.write("- è¤‡åˆã‚°ãƒ©ãƒ•ä½œæˆ")
    st.write("ğŸ”¥ ç›´å‰æ¯”ã‚³ãƒ¡ãƒ³ãƒˆãƒœãƒƒã‚¯ã‚¹")
    st.write("ğŸ”¥ æ¥ç¶šç·šä»˜ãæ³¨ç›®ãƒã‚¤ãƒ³ãƒˆ")
    
    st.write("**â–  è¨­å®šæƒ…å ±:**")
    if enable_year_filter and year_range:
        st.write(f"- å¹´åº¦ç¯„å›²: {year_range[0]}å¹´ï½{year_range[1]}å¹´")
    else:
        st.write("- å¹´åº¦ç¯„å›²: å…¨æœŸé–“")
    
    if enable_highlight:
        st.write("- ç›´å‰æ¯”å¼·èª¿: æœ‰åŠ¹")
    else:
        st.write("- ç›´å‰æ¯”å¼·èª¿: ç„¡åŠ¹")
    
    st.write("**â–  ä½¿ç”¨æ–¹æ³•:**")
    st.write("1. ã‚«ãƒ†ã‚´ãƒªåˆ¥ã«CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ")
    st.write("2. ã‚°ãƒ©ãƒ•è¨­å®šã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º")
    st.write("3. ç›´å‰æ¯”AIåˆ†æçµæœã‚’ç¢ºèª")
    st.write("4. PowerPointãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆãƒ»ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰")
    
    st.write("**â–  NEW: ç›´å‰æ¯”åˆ†æ:**")
    st.write("- æœ€ã‚‚ä¸Šæ˜‡ã—ãŸ2ç‚¹ã‚’è‡ªå‹•æ¤œå‡º")
    st.write("- æœ€ã‚‚ä¸‹è½ã—ãŸ2ç‚¹ã‚’è‡ªå‹•æ¤œå‡º")
    st.write("- ç›´å‰ãƒ‡ãƒ¼ã‚¿ã¨ã®æ¯”è¼ƒåˆ†æ")
    st.write("- ã‚ˆã‚Šæ•æ„ŸãªçŸ­æœŸå¤‰åŒ–ã‚’æ‰ãˆã‚‹")
    st.write("- å¤‰åŒ–ç‡%ã‚’å«ã‚€ã‚³ãƒ¡ãƒ³ãƒˆè¡¨ç¤º")
    st.write("- ä¸Šæ˜‡ãƒ»ä¸‹è½æ–¹å‘ã‚’è€ƒæ…®ã—ãŸAIåˆ†æ")
    
    st.write("**â–  å¤‰åŒ–ç‚¹æ¤œå‡ºã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ :**")
    st.write("1. æ™‚ç³»åˆ—é †ã«ãƒ‡ãƒ¼ã‚¿ã‚’ã‚½ãƒ¼ãƒˆ")
    st.write("2. å„ç‚¹ã¨ç›´å‰ã®ç‚¹ã®å¤‰åŒ–ç‡ã‚’è¨ˆç®—")
    st.write("3. æ­£ã®å¤‰åŒ–ç‡ã‹ã‚‰ä¸Šä½2ã¤é¸æŠ")
    st.write("4. è² ã®å¤‰åŒ–ç‡ã‹ã‚‰ä¸‹ä½2ã¤é¸æŠ")
    st.write("5. åˆè¨ˆæœ€å¤§4ã¤ã®æ³¨ç›®ãƒã‚¤ãƒ³ãƒˆæŠ½å‡º")
    
    st.write("**â–  ã‚³ãƒ¡ãƒ³ãƒˆç”Ÿæˆä»•æ§˜:**")
    st.write("- ç†ç”±: 30æ–‡å­—ä»¥å†…")
    st.write("- æ–‡æœ«: æ–­è¨€èª¿ã€Œï½ã ã€ã€Œï½ã§ã‚ã‚‹ã€ã€Œï½ã—ãŸã€")
    st.write("- å¤‰åŒ–ç‡: ç›´å‰æ¯”Â±XX.X%")
    st.write("- èƒŒæ™¯è‰²: è–„ã„é»„è‰²")
    st.write("- æ ç·šè‰²: èµ¤è‰²")
    st.write("- ãƒ•ã‚©ãƒ³ãƒˆ: 9ptã€å¤ªå­—ã€é»’è‰²")
    
    st.write("**â–  æŠ€è¡“æƒ…å ±:**")
    st.write("- ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯: Streamlit")
    st.write("- AI: Google Gemini 2.5")
    st.write("- ã‚°ãƒ©ãƒ•: Matplotlib")
    st.write("- PPT: python-pptx")
    st.write("- ãƒ‡ãƒ¼ã‚¿å‡¦ç†: Pandas")
    st.write("- å›³å½¢: MSO_SHAPE.RECTANGLE")
    st.write("- æ¥ç¶šç·š: MSO_CONNECTOR_TYPE")
    st.write("- æ™‚ç³»åˆ—åˆ†æ: ç›´å‰æ¯”ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ")
